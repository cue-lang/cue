# Code generated internal/ci/ci_tool.cue; DO NOT EDIT.

name: Evict caches
"on":
  schedule:
    - cron: 0 2 * * *
  push:
    branches:
      - ci/test
jobs:
  test:
    if: ${{github.repository == 'cue-lang/cue'}}
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash
    steps:
      - run: |-
          echo ${{ secrets.CUECKOO_GITHUB_PAT }} | gh auth login --with-token
          gh extension install actions/gh-actions-cache
          for i in https://github.com/cue-lang/cue https://github.com/cue-lang/cue-trybot
          do
          	echo "Evicting caches for $i"
          	cd $(mktemp -d)
          	git init -b initialbranch
          	git remote add origin $i
          	for j in $(gh actions-cache list -L 100 | grep refs/ | awk '{print $1}')
          	do
          		gh actions-cache delete --confirm $j
          	done
          done

          # Now trigger the most recent workflow run on each of the default branches.
          # We do this by listing all the branches on the main repo and finding those
          # which match the protected branch patterns (globs).
          for j in $(curl -s -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.CUECKOO_GITHUB_PAT }}" -H "X-GitHub-Api-Version: 2022-11-28" -f https://api.github.com/repos/cue-lang/cue/branches | jq -r '.[] | .name')
          do
          	for i in master release-branch.*
          	do
          		if [[ "$j" != $i ]]; then
          			continue
          		fi

          		echo "$j is a match with $i"
          		echo Branch: $i
          sha=$(curl -s -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.CUECKOO_GITHUB_PAT }}" -H "X-GitHub-Api-Version: 2022-11-28" "https://api.github.com/repos/cue-lang/cue/commits/master" | jq -r '.sha')
          echo Latest commit: $sha
          id=$(curl -s -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.CUECKOO_GITHUB_PAT }}" -H "X-GitHub-Api-Version: 2022-11-28" "https://api.github.com/repos/cue-lang/cue/actions/workflows/trybot.yml/runs?branch=$j&event=push&head_sha=$sha&per_page=1" | jq -r '.workflow_runs[] | .id')
          if [[ "$id" != "" ]]
          then
          	echo Workflow ID for that sha: $id
          	curl -s -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.CUECKOO_GITHUB_PAT }}" -H "X-GitHub-Api-Version: 2022-11-28" -X POST https://api.github.com/repos/cue-lang/cue/actions/runs/$id/rerun
          	echo Successfull triggered re-run
          else
          	echo "$sha has not run the trybot workflow; skipping"
          fi

          		echo Branch: $i
          sha=$(curl -s -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.CUECKOO_GITHUB_PAT }}" -H "X-GitHub-Api-Version: 2022-11-28" "https://api.github.com/repos/cue-lang/cue-trybot/commits/master" | jq -r '.sha')
          echo Latest commit: $sha
          id=$(curl -s -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.CUECKOO_GITHUB_PAT }}" -H "X-GitHub-Api-Version: 2022-11-28" "https://api.github.com/repos/cue-lang/cue-trybot/actions/workflows/trybot.yml/runs?branch=$j&event=push&head_sha=$sha&per_page=1" | jq -r '.workflow_runs[] | .id')
          if [[ "$id" != "" ]]
          then
          	echo Workflow ID for that sha: $id
          	curl -s -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.CUECKOO_GITHUB_PAT }}" -H "X-GitHub-Api-Version: 2022-11-28" -X POST https://api.github.com/repos/cue-lang/cue-trybot/actions/runs/$id/rerun
          	echo Successfull triggered re-run
          else
          	echo "$sha has not run the trybot workflow; skipping"
          fi

          	done
          done
