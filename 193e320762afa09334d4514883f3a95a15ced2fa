{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "11845dfb_f9c5302b",
        "filename": "cmd/cue/cmd/script_test.go",
        "patchSetId": 1
      },
      "lineNbr": 153,
      "author": {
        "id": 1017723
      },
      "writtenOn": "2022-05-30T14:27:05Z",
      "side": 0,
      "message": "My understanding this stripping of the `exec ` prefix is critical. Because TestX is used as a harness for testscript repros that are submitted via issues. In that situation, \"exec cue ...\" is the incantation used to call cue. So this pre-processing of a testscript file is at least part of the story.",
      "revId": "193e320762afa09334d4514883f3a95a15ced2fa",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c5dfb693_74c95dfb",
        "filename": "cmd/cue/cmd/script_test.go",
        "patchSetId": 1
      },
      "lineNbr": 153,
      "author": {
        "id": 1017720
      },
      "writtenOn": "2022-05-30T14:41:31Z",
      "side": 0,
      "message": "You\u0027re right that I missed this detail.\n\nExactly why do we want to strip the \"exec\" in that scenario? Is it to make sure we use the same CUE version we\u0027re developing, or to use in-process-debugging tools like pprof? If it\u0027s just the former, I imagine one could do:\n\n    go install cuelang.org/go/cmd/cue \u0026\u0026 testscript test.txtar\n\nOr, to not require \"go install\" and use the same process:\n\n    sed -i -e \u0027s/exec cue/cue/\u0027 test.txtar \u0026\u0026 TESTSCRIPT_SAME_PROCESS\u003dtrue go test -run TestScript test.txtar\n\nI guess we could implement that last option as part of TESTSCRIPT_SAME_PROCESS, though testscript currently does not take anything like an io/fs.FS, so we\u0027d have to use a temp dir to rewrite the test script.\n\nOne way or another, I still think the old method is worse long term - for example, it ignores any non-CUE commands like cp or mv, so many non-trivial scripts simply won\u0027t work.",
      "parentUuid": "11845dfb_f9c5302b",
      "revId": "193e320762afa09334d4514883f3a95a15ced2fa",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2cc53253_b20878e0",
        "filename": "cmd/cue/cmd/script_test.go",
        "patchSetId": 1
      },
      "lineNbr": 153,
      "author": {
        "id": 1017720
      },
      "writtenOn": "2022-05-30T14:42:49Z",
      "side": 0,
      "message": "I messed up the -run syntax in the second command by the way, it would be more like:\n\n    sed -i -e \u0027s/exec cue/cue/\u0027 testdata/scripts/foobar.txt \u0026\u0026 TESTSCRIPT_SAME_PROCESS\u003dtrue go test -run TestScript/foobar",
      "parentUuid": "c5dfb693_74c95dfb",
      "revId": "193e320762afa09334d4514883f3a95a15ced2fa",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9e2faf1c_a72a7fe8",
        "filename": "cmd/cue/cmd/script_test.go",
        "patchSetId": 1
      },
      "lineNbr": 153,
      "author": {
        "id": 1017723
      },
      "writtenOn": "2022-05-30T14:45:58Z",
      "side": 0,
      "message": "testscript-esque repros submitted as issues need the \"exec cue\" incantation because cue is not a default command as part of https://pkg.go.dev/github.com/rogpeppe/go-internal/cmd/testscript. Hence if they did not have the \"exec \" prefix, issue reporters would not be able to run the repro locally. \n\nMy understanding is that Marcel often likes to then run these repros in-process so that he can use a debugger. \n\nHence the stripping of the \"exec \" prefix.",
      "parentUuid": "c5dfb693_74c95dfb",
      "revId": "193e320762afa09334d4514883f3a95a15ced2fa",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9a1c64ef_0c2175b2",
        "filename": "cmd/cue/cmd/script_test.go",
        "patchSetId": 1
      },
      "lineNbr": 153,
      "author": {
        "id": 1017720
      },
      "writtenOn": "2022-05-30T15:18:05Z",
      "side": 0,
      "message": "Ah, I see. So perhaps it could be called like:\n\n    TESTSCRIPT_DEBUG\u003dfoobar.txt go test -run TestScript\n\nThe DEBUG env var would:\n\n1) Copy the testscript file into a temporary directory\n2) Replace \"exec cue\" with \"cue\" with search and replace\n3) Run testscript on the temporary directory with the \"same process\" mode I implemented here\n\nThe result will be pretty similar to what I understand Marcel\u0027s current workflow to be, but it will use native testscript, so we\u0027ll support pretty much any testscript and not just trivial ones.\n\nI\u0027ll wait for him to give a quick review of this approach once he feels better, before I change the CL :)",
      "parentUuid": "9e2faf1c_a72a7fe8",
      "revId": "193e320762afa09334d4514883f3a95a15ced2fa",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    }
  ]
}