{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "b704ce0e_d313445f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 13,
      "author": {
        "id": 1017720
      },
      "writtenOn": "2024-04-07T04:09:27Z",
      "side": 1,
      "message": "remove this word?",
      "range": {
        "startLine": 13,
        "startChar": 17,
        "endLine": 13,
        "endChar": 20
      },
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "93ff6121_47b4ca8d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 13,
      "author": {
        "id": 1037843
      },
      "writtenOn": "2024-04-09T19:38:04Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "b704ce0e_d313445f",
      "range": {
        "startLine": 13,
        "startChar": 17,
        "endLine": 13,
        "endChar": 20
      },
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "68e25a86_da8808fd",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 14,
      "author": {
        "id": 1017720
      },
      "writtenOn": "2024-04-07T04:09:27Z",
      "side": 1,
      "message": "nit: lowercase fmt, as the command isn\u0027t capitalized, or say \"cue fmt\".",
      "range": {
        "startLine": 14,
        "startChar": 27,
        "endLine": 14,
        "endChar": 30
      },
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "48b4c13d_e904a0ae",
        "filename": "/COMMIT_MSG",
        "patchSetId": 4
      },
      "lineNbr": 14,
      "author": {
        "id": 1037843
      },
      "writtenOn": "2024-04-09T19:38:04Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "68e25a86_da8808fd",
      "range": {
        "startLine": 14,
        "startChar": 27,
        "endLine": 14,
        "endChar": 30
      },
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "7c360962_afdd025c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1017720
      },
      "writtenOn": "2024-04-07T04:09:27Z",
      "side": 1,
      "message": "In your commit message, can you summarize what sort of speed-up this provides for \"cue fmt ./...\" on your codebase? I seem to recall it was significant, and it would be good to include for the sake of showing that it really does matter.\n\nLGTM, adding Paul as a second reviewer to see if he agrees with the new API as well.",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8eecc9f3_737109b2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1017723
      },
      "writtenOn": "2024-04-09T05:03:46Z",
      "side": 1,
      "message": "Thanks for finding the problem here, Noam! \n\nI\u0027m not yet clear on how we should be fixing the problem so have replied with some questions to help get a better understanding.",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "dac9333a_1091709e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1037843
      },
      "writtenOn": "2024-04-09T06:13:48Z",
      "side": 1,
      "message": "I responded, it looks like it\u0027s worth discussing the expected behavior first before rushing to a solution",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "bcdc20d4_c5ede59f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1017723
      },
      "writtenOn": "2024-04-09T12:25:13Z",
      "side": 1,
      "message": "Thanks for the exchange here, Noam!",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "67fe565c_4f14531c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 4
      },
      "lineNbr": 0,
      "author": {
        "id": 1037843
      },
      "writtenOn": "2024-04-09T19:38:04Z",
      "side": 1,
      "message": "sure thing, added the info",
      "parentUuid": "7c360962_afdd025c",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "4b6351de_46847abd",
        "filename": "cue/build/instance.go",
        "patchSetId": 4
      },
      "lineNbr": 40,
      "author": {
        "id": 1017723
      },
      "writtenOn": "2024-04-09T05:03:46Z",
      "side": 1,
      "message": "I\u0027m not clear on what \"in the package directory\" means here. But per below, I\u0027m not yet clear we need the new API.\n\nIf I\u0027ve understood the problem correctly (and please let me know if I haven\u0027t) the issue comes because in the following example, `cue fmt ./...` from the root causes `p1.cue` to be formatted four times?\n\n    cue fmt ./...\n\n    -- cue.mod/module.cue --\n    module: \"mod.example\"\n    language: {\n            version: \"v0.9.0-alpha.1\"\n    }\n    -- a/b/c/p4.cue --\n    package p\n\n    x: 5\n    -- a/b/p3.cue --\n    package p\n\n    x: 5\n    -- a/p2.cue --\n    package p\n\n    x: 5\n    -- p1.cue --\n    package p\n\n    x: 5\n\n\nIf so, can we not resolve this by only working with the `BuildFiles` that are in the same directory as the _instance_ (`cue/build.Instance.Dir`)?\n\nThat said, I\u0027m not sure if this \"solves\" this from the user perspective or not.\n\nConsider again the example above, running `cue fmt ./a/b/c`. Should that format `p1.cue`?",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a27f23b0_fbbffbcc",
        "filename": "cue/build/instance.go",
        "patchSetId": 4
      },
      "lineNbr": 40,
      "author": {
        "id": 1037843
      },
      "writtenOn": "2024-04-09T06:13:48Z",
      "side": 1,
      "message": "The terminology in my comment was not accurate - you\u0027re right, I meant instance directory.\n\nMy thought was that from a user perspective, running either `cue fmt ./...` or, as in your example, `cue fmt ./a/b/c` should only cause files in the directories below the specified directory / pattern to be formatted.\n\nI think (and this might be wrong) that users see `cue fmt` as a command that is more file system based and not related to cue concepts like instance/pkg/module, so they wouldn\u0027t expect commands like `cue fmt ./a/b/c` to format all files in the instance - rather to format all files in the directory.",
      "parentUuid": "4b6351de_46847abd",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "36e90379_23e8fe4c",
        "filename": "cue/build/instance.go",
        "patchSetId": 4
      },
      "lineNbr": 40,
      "author": {
        "id": 1017720
      },
      "writtenOn": "2024-04-09T07:01:21Z",
      "side": 1,
      "message": "I tend to agree with Noam here. Another way to think about this is - if I run `cd a \u0026\u0026 cue fmt ./...`, I would find it extremely surprising if any files in parent directories are formatted as well.\n\nThat said, I think we should have a few more test, for completeness. For example, like:\n\n```\ncue fmt a/b/c/p4.cue # should only format p4.cue\ncue fmt p1.cue a/b/c/p4.cue # should format p1.cue and p4.cue, but not p2.cue or p3.cue\ncue fmt ./a/b/... # should format p3.cue and p4.cue, but not p1.cue or p2.cue\n```\n\nI think we should copy a file/directory structure like what Paul shows, perhaps with names like `p_root.cue`, `a/p_a.cue`, `a/b/p_b.cue`, and `a/b/c/p_c.cue`, as that should make it easier to remember which file is which, and test more scenarios with nesting directories.",
      "parentUuid": "a27f23b0_fbbffbcc",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5364b2ab_1c4c70ba",
        "filename": "cue/build/instance.go",
        "patchSetId": 4
      },
      "lineNbr": 40,
      "author": {
        "id": 1017723
      },
      "writtenOn": "2024-04-09T07:02:02Z",
      "side": 1,
      "message": "I think it gets tricky if the user were to run `cue fmt mod.example/a/b/c:p` in my example above. Because that is not a directory-based command argument. \n\nBut I think you\u0027re right that people will tend to run `cue fmt` with a directory argument, or a directory-based pattern like `./...`. \n\nSo I\u0027m happy with proceeding on that approach, I just don\u0027t think we need the new `DirectFiles` on a `cue/build.Instance`. Instead, you can check whether the `BuildFiles` belong to the directory on the instance?",
      "parentUuid": "a27f23b0_fbbffbcc",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "29a425f5_b156c54d",
        "filename": "cue/build/instance.go",
        "patchSetId": 4
      },
      "lineNbr": 40,
      "author": {
        "id": 1017720
      },
      "writtenOn": "2024-04-09T07:02:22Z",
      "side": 1,
      "message": "I also realise that maybe we should have used an issue before diving directly into a CL, but I honestly thought that this wasn\u0027t going to be a controversial suggestion at all, beyond the API change :) I think we can all agree that the current `cue fmt` is wrong, at the very least because it formats some files many times over.",
      "parentUuid": "36e90379_23e8fe4c",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3f6ebc4e_8d1c1ae4",
        "filename": "cue/build/instance.go",
        "patchSetId": 4
      },
      "lineNbr": 40,
      "author": {
        "id": 1017723
      },
      "writtenOn": "2024-04-09T07:04:13Z",
      "side": 1,
      "message": "\u003e I tend to agree with Noam here. Another way to think about this is - if I run cd a \u0026\u0026 cue fmt ./..., I would find it extremely surprising if any files in parent directories are formatted as well.\n\nThat\u0027s a good point with respect to `fmt`. That would tend to suggest (but this could be for a later CL) that `fmt` should only accept directory-based arguments.",
      "parentUuid": "29a425f5_b156c54d",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "59cbf65d_262fe311",
        "filename": "cue/build/instance.go",
        "patchSetId": 4
      },
      "lineNbr": 40,
      "author": {
        "id": 1037843
      },
      "writtenOn": "2024-04-09T07:07:10Z",
      "side": 1,
      "message": "So I suppose I\u0027ll remove the API change, localize the change in the cue fmt command itself, and add some more specific tests?",
      "parentUuid": "29a425f5_b156c54d",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "74ff960c_6ba2a67a",
        "filename": "cue/build/instance.go",
        "patchSetId": 4
      },
      "lineNbr": 40,
      "author": {
        "id": 1017720
      },
      "writtenOn": "2024-04-09T07:10:08Z",
      "side": 1,
      "message": "Personally, on the Go world I almost never, ever, use `go fmt` as it works on packages. I only use `gofmt` as it works on files and directories :) `go fmt ./foo/bar` or `go fmt ./...` still work with packages, and IMHO `gofmt -l -w foo/bar` or `gofmt -l -w .` are simply superior (and faster).\n\nWe could sidestep these package/instance loading issues if we taught `cue fmt` to have a \"files\" mode as well, but I think we need to fix the existing mode so that it\u0027s less wasteful and confusing first.\n\nYour last suggestion sounds good to me, Noam. We can always decide to add cue/load API later if others want something similar to what cue fmt does.",
      "parentUuid": "3f6ebc4e_8d1c1ae4",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "457ca0e5_5cd26f80",
        "filename": "cue/build/instance.go",
        "patchSetId": 4
      },
      "lineNbr": 40,
      "author": {
        "id": 1017723
      },
      "writtenOn": "2024-04-09T12:25:13Z",
      "side": 1,
      "message": "\u003e Your last suggestion sounds good to me, Noam. We can always decide to add cue/load API later if others want something similar to what cue fmt does.\n\nAgreed.",
      "parentUuid": "74ff960c_6ba2a67a",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ea2b8e83_256e1a73",
        "filename": "cue/build/instance.go",
        "patchSetId": 4
      },
      "lineNbr": 40,
      "author": {
        "id": 1037843
      },
      "writtenOn": "2024-04-09T19:38:04Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "457ca0e5_5cd26f80",
      "revId": "54372a56abc4e95e48de1d817d38146e72102da5",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    }
  ]
}