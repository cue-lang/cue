-- in.cue --
given: {
	INC: USD: 2.0
	USD: GBP: 3.0
}
hydrated: {
	for k, v in given {
		for k1, r in v {
			"\(k)": "\(k)":   1.0
			"\(k1)": "\(k1)": 1.0
			"\(k)": "\(k1)":  r
			"\(k1)": "\(k)":  number
		}
	}
}

foo: {
	a: 10
	if a < 20 {
		if a < 50 {
			b: 20
		}
	}
}

indirectlyNested: {
	a: true // must be declared outside of the nested comprehensions for test.
	if true {
		b: {
			if a {
				a
			}
		}
	}
}

directlyNestedEmpty: {
	a: true
	if true {
		if a {
		}
	}
}

directlyDoublyNestedEmpty: {
	a: true 
	if true {
		if a {
		}
	}
}

indirectlyDoublyNestedEmpty: {
	a: true
	b: {
		if true {
			if a {
				if a {
					a
				}
			}
			if a {
				a
			}
		}
	}
}

indirectlyDoublyNested: {
	a: true
	if true {
		if a {
			if a {
				b: 1
			}
		}
		if a {
			c: 1
		}
	}
}

// This case used to trigger an over-aggressive deduplication.
issue1974: {
	X: {
		foo: {
			bar: ""
			baz: ""
		}
	}
	out: {
		for k, v in X for vk, vv in v {
			"\(k)": "\(vk)": vv
		}
	}
}
-- pending.cue --
// Trigger notification while an arc is still pending.
T: int
for C in Y {
	let X = C.M
	T:  X.V
}
Y: x: {
	M: V: 1
	for _ in M {
		if true { M: {} }
	}
}
-- issue3940.cue --
// Test chained comprehension clauses (without braces)
issue3940: reduced1: {
	X
	a: b: X
	a: b: a: b: {y: X}

	X: {
		a: {}

		objects: {
			for v in a
			for _ in ({} & v).objects {
			}
		}
	}
}

// Test nested comprehensions (with braces) - should work as before
issue3940: reduced2: {
	X
	a: b: X
	a: b: a: b: {y: X}

	X: {
		a: {}

		objects: {
			for v in a
			for _ in ({} & v).objects {
			}
		}
	}
}
issue3940: reduced3: {
	a: E
	a: i: x: E
	a: i: x: i: x: E
	E: {
		i: {}
		o: [for m in i for v in ({} & m).o {}]
	}
}
issue3940: reduced4: {
	out: Exporter & {
		_imports: [{
			objects: {...}
			#export: Exporter & {
				_imports: [{ #export: Exporter }]
			}
		}]
	}

	Exporter: {
		_imports: [...]
		objects: [
			for v in _imports for obj in ({} & v.#export).objects {
				obj
			},
		]
	}
}
issue3940: let: {
	X
	a: b: X
	a: b: a: b: {y: X}

	X: {
		a: {}

		objects: {
			for v in a
			let x = ({} & v)
			for _ in x.objects {
			}
		}
	}
}
issue3940: full: {
	out: #Exporter & {
		_imports: [_branch]
		#conf: global: region: "Europe"
	}

	_branch: {
		objects: branch: {
			#conf: {...}
			region: #conf.global.region
		}
		imports: [_leaf]
		#export: #Exporter & {
			_objects: objects
			_imports: imports
		}
	}
	_leaf: {
		objects: leaf: {
			#conf: {...}
			region: #conf.global.region
		}
		#export: #Exporter & {
			_objects: objects
		}
	}
	#Exporter: {
		CONF=#conf: {...}
		_objects: {...}
		_imports: [...]

		objects: [
			// local objects
			for name, obj in _objects & {[string]: #conf: CONF} {
				(name): obj
			},

			// transitively imported objects
			for import in _imports
			for obj in ({#conf: CONF} & import.#export).objects {
				obj
			},
		]
	}
}
-- issue3990.cue --
issue3990: {
	_imports: [_noVolumes, _someVolumes]
	_noVolumes: {
		name: "noVolumes"
		exportObjs: deployment: _Deployment & {
			volumes: []
		}
	}
	_someVolumes: {
		name: "someVolumes"
		exportObjs: deployment: _Deployment & {
			volumes: [{name: "data"}]
		}
	}

	for import in _imports
	for _, obj in ({extra: "unused"} & import).exportObjs {(import.name): obj},

	_Deployment: this={
		_names: {
			for _, v in this.volumes {
				(v.name): v.name
			}
		}
		// skip volumeNames if empty
		if len(_names) > 0 {
			volumeNames: [for _, v in _names {v}]
		}
	}
}
-- out/evalalpha/stats --
Leaks:  24
Freed:  422
Reused: 379
Allocs: 67
Retain: 0

Unifications: 419
Conjuncts:    769
Disjuncts:    0
Notifications: 7

NumCloseIDs: 222
-- diff/-out/evalalpha/stats<==>+out/eval/stats --
diff old new
--- old
+++ new
@@ -1,13 +1,12 @@
-Leaks:  44
-Freed:  726
-Reused: 713
-Allocs: 57
-Retain: 121
-
-Unifications: 770
-Conjuncts:    1669
-Disjuncts:    838
-
-MisalignedConjunct: 48
-
-NumCloseIDs: 101
+Leaks:  24
+Freed:  422
+Reused: 379
+Allocs: 67
+Retain: 0
+
+Unifications: 419
+Conjuncts:    769
+Disjuncts:    0
+Notifications: 7
+
+NumCloseIDs: 222
-- out/eval/stats --
Leaks:  44
Freed:  726
Reused: 713
Allocs: 57
Retain: 121

Unifications: 770
Conjuncts:    1669
Disjuncts:    838

MisalignedConjunct: 48

NumCloseIDs: 101
-- out/evalalpha --
Errors:
y: structural cycle:
    ./issue3940.cue:12:14
y: structural cycle:
    ./issue3940.cue:29:14
structural cycle:
    ./issue3940.cue:40:28
structural cycle:
    ./issue3940.cue:56:34
structural cycle:
    ./issue3940.cue:117:16
exportObjs.deployment._names: adding field data not allowed as field set was already referenced:
    ./issue3990.cue:22:15

Result:
(_|_){
  // [eval]
  given: (struct){
    INC: (struct){
      USD: (float){ 2.0 }
    }
    USD: (struct){
      GBP: (float){ 3.0 }
    }
  }
  hydrated: (struct){
    INC: (struct){
      INC: (float){ 1.0 }
      USD: (float){ 2.0 }
    }
    USD: (struct){
      USD: (float){ 1.0 }
      INC: (number){ number }
      GBP: (float){ 3.0 }
    }
    GBP: (struct){
      GBP: (float){ 1.0 }
      USD: (number){ number }
    }
  }
  foo: (struct){
    a: (int){ 10 }
    b: (int){ 20 }
  }
  indirectlyNested: (struct){
    a: (bool){ true }
    b: (bool){ true }
  }
  directlyNestedEmpty: (struct){
    a: (bool){ true }
  }
  directlyDoublyNestedEmpty: (struct){
    a: (bool){ true }
  }
  indirectlyDoublyNestedEmpty: (struct){
    a: (bool){ true }
    b: (bool){ true }
  }
  indirectlyDoublyNested: (struct){
    a: (bool){ true }
    c: (int){ 1 }
    b: (int){ 1 }
  }
  issue1974: (struct){
    X: (struct){
      foo: (struct){
        bar: (string){ "" }
        baz: (string){ "" }
      }
    }
    out: (struct){
      foo: (struct){
        bar: (string){ "" }
        baz: (string){ "" }
      }
    }
  }
  issue3940: (_|_){
    // [structural cycle]
    reduced1: (_|_){
      // [structural cycle]
      a: (struct){
        b: (struct){
          a: (struct){
            b: (struct){
              y: ~(issue3940.reduced1.X)
            }
          }
          objects: (_|_){
            // [incomplete] issue3940.reduced1.a.b.objects: undefined field: objects:
            //     ./issue3940.cue:12:22
          }
        }
      }
      X: (struct){
        a: (struct){
        }
        objects: (struct){
        }
      }
      objects: (_|_){
        // [structural cycle] y: structural cycle:
        //     ./issue3940.cue:12:14
      }
    }
    reduced2: (_|_){
      // [structural cycle]
      a: (struct){
        b: (struct){
          a: (struct){
            b: (struct){
              y: ~(issue3940.reduced2.X)
            }
          }
          objects: (_|_){
            // [incomplete] issue3940.reduced2.a.b.objects: undefined field: objects:
            //     ./issue3940.cue:29:22
          }
        }
      }
      X: (struct){
        a: (struct){
        }
        objects: (struct){
        }
      }
      objects: (_|_){
        // [structural cycle] y: structural cycle:
        //     ./issue3940.cue:29:14
      }
    }
    reduced3: (_|_){
      // [structural cycle]
      a: (_|_){
        // [structural cycle]
        i: (struct){
          x: (struct){
            i: (struct){
              x: ~(issue3940.reduced3.E)
            }
            o: (#list){
            }
          }
        }
        o: (_|_){
          // [structural cycle] structural cycle:
          //     ./issue3940.cue:40:28
        }
      }
      E: (struct){
        i: (struct){
        }
        o: (#list){
        }
      }
    }
    reduced4: (_|_){
      // [structural cycle]
      out: (_|_){
        // [structural cycle]
        _imports: (#list){
          0: (struct){
            objects: (struct){
            }
            #export: (#struct){
              _imports: (#list){
                0: (#struct){
                  #export: (#struct){
                    _imports: (list){
                    }
                    objects: (#list){
                    }
                  }
                }
              }
              objects: (#list){
              }
            }
          }
        }
        objects: (_|_){
          // [structural cycle] structural cycle:
          //     ./issue3940.cue:56:34
        }
      }
      Exporter: (struct){
        _imports: (list){
        }
        objects: (#list){
        }
      }
    }
    let: (struct){
      a: (struct){
        b: (struct){
          a: (struct){
            b: (struct){
              y: ~(issue3940.let.X)
            }
          }
          objects: (_|_){
            // [incomplete] issue3940.let.a.b.objects: undefined field: objects:
            //     ./issue3940.cue:73:15
          }
        }
      }
      X: (struct){
        a: (struct){
        }
        objects: (struct){
        }
      }
      objects: (_|_){
        // [incomplete] objects: undefined field: objects:
        //     ./issue3940.cue:73:15
      }
    }
    full: (_|_){
      // [structural cycle]
      out: (_|_){
        // [structural cycle]
        _imports: (#list){
          0: (#struct){
            objects: (#struct){
              branch: (#struct){
                #conf: (#struct){
                }
                region: (_|_){
                  // [incomplete] issue3940.full.out._imports.0.objects.branch.region: undefined field: global:
                  //     ./issue3940.cue:87:18
                }
              }
            }
            imports: (#list){
              0: (#struct){
                objects: (#struct){
                  leaf: (#struct){
                    #conf: (#struct){
                    }
                    region: (_|_){
                      // [incomplete] issue3940.full.out._imports.0.imports.0.objects.leaf.region: undefined field: global:
                      //     ./issue3940.cue:98:18
                    }
                  }
                }
                #export: (#struct){
                  _objects: (#struct){
                    leaf: (#struct){
                      #conf: (#struct){
                      }
                      region: (_|_){
                        // [incomplete] issue3940.full.out._imports.0.imports.0.#export._objects.leaf.region: undefined field: global:
                        //     ./issue3940.cue:98:18
                      }
                    }
                  }
                  #conf: (#struct){
                  }
                  _imports: (list){
                  }
                  objects: (#list){
                    0: (#struct){
                      leaf: (#struct){
                        #conf: (#struct){
                        }
                        region: (_|_){
                          // [incomplete] issue3940.full.out._imports.0.imports.0.#export.objects.0.leaf.region: undefined field: global:
                          //     ./issue3940.cue:98:18
                        }
                      }
                    }
                  }
                }
              }
            }
            #export: (#struct){
              _objects: (#struct){
                branch: (#struct){
                  #conf: (#struct){
                  }
                  region: (_|_){
                    // [incomplete] issue3940.full.out._imports.0.#export._objects.branch.region: undefined field: global:
                    //     ./issue3940.cue:87:18
                  }
                }
              }
              _imports: (#list){
                0: (#struct){
                  objects: (#struct){
                    leaf: (#struct){
                      #conf: (#struct){
                      }
                      region: (_|_){
                        // [incomplete] issue3940.full.out._imports.0.#export._imports.0.objects.leaf.region: undefined field: global:
                        //     ./issue3940.cue:98:18
                      }
                    }
                  }
                  #export: (#struct){
                    _objects: (#struct){
                      leaf: (#struct){
                        #conf: (#struct){
                        }
                        region: (_|_){
                          // [incomplete] issue3940.full.out._imports.0.#export._imports.0.#export._objects.leaf.region: undefined field: global:
                          //     ./issue3940.cue:98:18
                        }
                      }
                    }
                    #conf: (#struct){
                    }
                    _imports: (list){
                    }
                    objects: (#list){
                      0: (#struct){
                        leaf: (#struct){
                          #conf: (#struct){
                          }
                          region: (_|_){
                            // [incomplete] issue3940.full.out._imports.0.#export._imports.0.#export.objects.0.leaf.region: undefined field: global:
                            //     ./issue3940.cue:98:18
                          }
                        }
                      }
                    }
                  }
                }
              }
              #conf: (#struct){
              }
              objects: (#list){
                0: (#struct){
                  branch: (#struct){
                    #conf: (#struct){
                    }
                    region: (_|_){
                      // [incomplete] issue3940.full.out._imports.0.#export.objects.0.branch.region: undefined field: global:
                      //     ./issue3940.cue:87:18
                    }
                  }
                }
                1: (#struct){
                  leaf: (#struct){
                    #conf: (#struct){
                    }
                    region: (_|_){
                      // [incomplete] issue3940.full.out._imports.0.#export.objects.1.leaf.region: undefined field: global:
                      //     ./issue3940.cue:98:18
                    }
                  }
                }
              }
            }
          }
        }
        #conf: (#struct){
          global: (#struct){
            region: (string){ "Europe" }
          }
        }
        _objects: (#struct){
        }
        objects: (_|_){
          // [structural cycle] structural cycle:
          //     ./issue3940.cue:117:16
        }
      }
      _branch: (struct){
        objects: (struct){
          branch: (struct){
            #conf: (#struct){
            }
            region: (_|_){
              // [incomplete] issue3940.full._branch.objects.branch.region: undefined field: global:
              //     ./issue3940.cue:87:18
            }
          }
        }
        imports: (#list){
          0: ~(issue3940.full._leaf)
        }
        #export: (#struct){
          _objects: (#struct){
            branch: (#struct){
              #conf: (#struct){
              }
              region: (_|_){
                // [incomplete] issue3940.full._branch.#export._objects.branch.region: undefined field: global:
                //     ./issue3940.cue:87:18
              }
            }
          }
          _imports: (#list){
            0: (#struct){
              objects: (#struct){
                leaf: (#struct){
                  #conf: (#struct){
                  }
                  region: (_|_){
                    // [incomplete] issue3940.full._branch.#export._imports.0.objects.leaf.region: undefined field: global:
                    //     ./issue3940.cue:98:18
                  }
                }
              }
              #export: (#struct){
                _objects: (#struct){
                  leaf: (#struct){
                    #conf: (#struct){
                    }
                    region: (_|_){
                      // [incomplete] issue3940.full._branch.#export._imports.0.#export._objects.leaf.region: undefined field: global:
                      //     ./issue3940.cue:98:18
                    }
                  }
                }
                #conf: (#struct){
                }
                _imports: (list){
                }
                objects: (#list){
                  0: (#struct){
                    leaf: (#struct){
                      #conf: (#struct){
                      }
                      region: (_|_){
                        // [incomplete] issue3940.full._branch.#export._imports.0.#export.objects.0.leaf.region: undefined field: global:
                        //     ./issue3940.cue:98:18
                      }
                    }
                  }
                }
              }
            }
          }
          #conf: (#struct){
          }
          objects: (#list){
            0: (#struct){
              branch: (#struct){
                #conf: (#struct){
                }
                region: (_|_){
                  // [incomplete] issue3940.full._branch.#export.objects.0.branch.region: undefined field: global:
                  //     ./issue3940.cue:87:18
                }
              }
            }
            1: (#struct){
              leaf: (#struct){
                #conf: (#struct){
                }
                region: (_|_){
                  // [incomplete] issue3940.full._branch.#export.objects.1.leaf.region: undefined field: global:
                  //     ./issue3940.cue:98:18
                }
              }
            }
          }
        }
      }
      _leaf: (struct){
        objects: (struct){
          leaf: (struct){
            #conf: (#struct){
            }
            region: (_|_){
              // [incomplete] issue3940.full._leaf.objects.leaf.region: undefined field: global:
              //     ./issue3940.cue:98:18
            }
          }
        }
        #export: (#struct){
          _objects: (#struct){
            leaf: (#struct){
              #conf: (#struct){
              }
              region: (_|_){
                // [incomplete] issue3940.full._leaf.#export._objects.leaf.region: undefined field: global:
                //     ./issue3940.cue:98:18
              }
            }
          }
          #conf: (#struct){
          }
          _imports: (list){
          }
          objects: (#list){
            0: (#struct){
              leaf: (#struct){
                #conf: (#struct){
                }
                region: (_|_){
                  // [incomplete] issue3940.full._leaf.#export.objects.0.leaf.region: undefined field: global:
                  //     ./issue3940.cue:98:18
                }
              }
            }
          }
        }
      }
      #Exporter: (#struct){
        #conf: (#struct){
        }
        _objects: (#struct){
        }
        _imports: (list){
        }
        objects: (#list){
        }
      }
    }
  }
  issue3990: (_|_){
    // [eval] exportObjs.deployment._names: adding field data not allowed as field set was already referenced:
    //     ./issue3990.cue:22:15
    _imports: (#list){
      0: ~(issue3990._noVolumes)
      1: ~(issue3990._someVolumes)
    }
    _noVolumes: (struct){
      name: (string){ "noVolumes" }
      exportObjs: (struct){
        deployment: (struct){
          volumes: (#list){
          }
          _names: (struct){
          }
        }
      }
    }
    _someVolumes: (struct){
      name: (string){ "someVolumes" }
      exportObjs: (struct){
        deployment: (struct){
          volumes: (#list){
            0: (struct){
              name: (string){ "data" }
            }
          }
          _names: (struct){
            data: (string){ "data" }
          }
          volumeNames: (#list){
            0: (string){ "data" }
          }
        }
      }
    }
    _Deployment: (_|_){
      // [incomplete] issue3990._Deployment._names: undefined field: volumes:
      //     ./issue3990.cue:21:21
      _names: (_|_){
        // [incomplete] issue3990._Deployment._names: undefined field: volumes:
        //     ./issue3990.cue:21:21
      }
    }
  }
  T: (int){ 1 }
  let X#1multi = 〈1;C〉.M
  Y: (struct){
    x: (struct){
      M: (struct){
        V: (int){ 1 }
      }
    }
  }
}
-- diff/-out/evalalpha<==>+out/eval --
diff old new
--- old
+++ new
@@ -1,4 +1,20 @@
-(struct){
+Errors:
+y: structural cycle:
+    ./issue3940.cue:12:14
+y: structural cycle:
+    ./issue3940.cue:29:14
+structural cycle:
+    ./issue3940.cue:40:28
+structural cycle:
+    ./issue3940.cue:56:34
+structural cycle:
+    ./issue3940.cue:117:16
+exportObjs.deployment._names: adding field data not allowed as field set was already referenced:
+    ./issue3990.cue:22:15
+
+Result:
+(_|_){
+  // [eval]
   given: (struct){
     INC: (struct){
       USD: (float){ 2.0 }
@@ -59,18 +75,15 @@
       }
     }
   }
-  issue3940: (struct){
-    reduced1: (struct){
-      a: (struct){
-        b: (struct){
-          a: (struct){
-            b: (struct){
-              y: (struct){
-                a: (struct){
-                }
-                objects: (struct){
-                }
-              }
+  issue3940: (_|_){
+    // [structural cycle]
+    reduced1: (_|_){
+      // [structural cycle]
+      a: (struct){
+        b: (struct){
+          a: (struct){
+            b: (struct){
+              y: ~(issue3940.reduced1.X)
             }
           }
           objects: (_|_){
@@ -86,21 +99,17 @@
         }
       }
       objects: (_|_){
-        // [incomplete] objects: undefined field: objects:
-        //     ./issue3940.cue:12:22
-      }
-    }
-    reduced2: (struct){
-      a: (struct){
-        b: (struct){
-          a: (struct){
-            b: (struct){
-              y: (struct){
-                a: (struct){
-                }
-                objects: (struct){
-                }
-              }
+        // [structural cycle] y: structural cycle:
+        //     ./issue3940.cue:12:14
+      }
+    }
+    reduced2: (_|_){
+      // [structural cycle]
+      a: (struct){
+        b: (struct){
+          a: (struct){
+            b: (struct){
+              y: ~(issue3940.reduced2.X)
             }
           }
           objects: (_|_){
@@ -116,27 +125,26 @@
         }
       }
       objects: (_|_){
-        // [incomplete] objects: undefined field: objects:
-        //     ./issue3940.cue:29:22
-      }
-    }
-    reduced3: (struct){
-      a: (struct){
+        // [structural cycle] y: structural cycle:
+        //     ./issue3940.cue:29:14
+      }
+    }
+    reduced3: (_|_){
+      // [structural cycle]
+      a: (_|_){
+        // [structural cycle]
         i: (struct){
           x: (struct){
             i: (struct){
-              x: (struct){
-                i: (struct){
-                }
-                o: (#list){
-                }
-              }
+              x: ~(issue3940.reduced3.E)
             }
             o: (#list){
             }
           }
         }
-        o: (#list){
+        o: (_|_){
+          // [structural cycle] structural cycle:
+          //     ./issue3940.cue:40:28
         }
       }
       E: (struct){
@@ -146,29 +154,33 @@
         }
       }
     }
-    reduced4: (struct){
-      out: (struct){
-        _imports: (#list){
-          0: (struct){
-            objects: (struct){
-            }
-            #export: (#struct){
-              _imports: (#list){
-                0: (#struct){
-                  #export: (#struct){
-                    _imports: (list){
-                    }
-                    objects: (#list){
-                    }
-                  }
-                }
-              }
-              objects: (#list){
-              }
-            }
-          }
-        }
-        objects: (#list){
+    reduced4: (_|_){
+      // [structural cycle]
+      out: (_|_){
+        // [structural cycle]
+        _imports: (#list){
+          0: (struct){
+            objects: (struct){
+            }
+            #export: (#struct){
+              _imports: (#list){
+                0: (#struct){
+                  #export: (#struct){
+                    _imports: (list){
+                    }
+                    objects: (#list){
+                    }
+                  }
+                }
+              }
+              objects: (#list){
+              }
+            }
+          }
+        }
+        objects: (_|_){
+          // [structural cycle] structural cycle:
+          //     ./issue3940.cue:56:34
         }
       }
       Exporter: (struct){
@@ -183,12 +195,7 @@
         b: (struct){
           a: (struct){
             b: (struct){
-              y: (struct){
-                a: (struct){
-                }
-                objects: (struct){
-                }
-              }
+              y: ~(issue3940.let.X)
             }
           }
           objects: (_|_){
@@ -208,19 +215,14 @@
         //     ./issue3940.cue:73:15
       }
     }
-    full: (struct){
-      out: (#struct){
-        #conf: (#struct){
-          global: (#struct){
-            region: (string){ "Europe" }
-          }
-        }
-        _objects: (#struct){
-        }
-        _imports: (#list){
-          0: (struct){
-            objects: (struct){
-              branch: (struct){
+    full: (_|_){
+      // [structural cycle]
+      out: (_|_){
+        // [structural cycle]
+        _imports: (#list){
+          0: (#struct){
+            objects: (#struct){
+              branch: (#struct){
                 #conf: (#struct){
                 }
                 region: (_|_){
@@ -230,9 +232,9 @@
               }
             }
             imports: (#list){
-              0: (struct){
-                objects: (struct){
-                  leaf: (struct){
+              0: (#struct){
+                objects: (#struct){
+                  leaf: (#struct){
                     #conf: (#struct){
                     }
                     region: (_|_){
@@ -242,8 +244,6 @@
                   }
                 }
                 #export: (#struct){
-                  #conf: (#struct){
-                  }
                   _objects: (#struct){
                     leaf: (#struct){
                       #conf: (#struct){
@@ -254,6 +254,8 @@
                       }
                     }
                   }
+                  #conf: (#struct){
+                  }
                   _imports: (list){
                   }
                   objects: (#list){
@@ -272,8 +274,6 @@
               }
             }
             #export: (#struct){
-              #conf: (#struct){
-              }
               _objects: (#struct){
                 branch: (#struct){
                   #conf: (#struct){
@@ -297,8 +297,6 @@
                     }
                   }
                   #export: (#struct){
-                    #conf: (#struct){
-                    }
                     _objects: (#struct){
                       leaf: (#struct){
                         #conf: (#struct){
@@ -309,6 +307,8 @@
                         }
                       }
                     }
+                    #conf: (#struct){
+                    }
                     _imports: (list){
                     }
                     objects: (#list){
@@ -326,6 +326,8 @@
                   }
                 }
               }
+              #conf: (#struct){
+              }
               objects: (#list){
                 0: (#struct){
                   branch: (#struct){
@@ -351,27 +353,16 @@
             }
           }
         }
-        objects: (#list){
-          0: (#struct){
-            branch: (#struct){
-              #conf: (#struct){
-                global: (#struct){
-                  region: (string){ "Europe" }
-                }
-              }
-              region: (string){ "Europe" }
-            }
-          }
-          1: (#struct){
-            leaf: (#struct){
-              #conf: (#struct){
-                global: (#struct){
-                  region: (string){ "Europe" }
-                }
-              }
-              region: (string){ "Europe" }
-            }
-          }
+        #conf: (#struct){
+          global: (#struct){
+            region: (string){ "Europe" }
+          }
+        }
+        _objects: (#struct){
+        }
+        objects: (_|_){
+          // [structural cycle] structural cycle:
+          //     ./issue3940.cue:117:16
         }
       }
       _branch: (struct){
@@ -386,50 +377,9 @@
           }
         }
         imports: (#list){
-          0: (struct){
-            objects: (struct){
-              leaf: (struct){
-                #conf: (#struct){
-                }
-                region: (_|_){
-                  // [incomplete] issue3940.full._branch.imports.0.objects.leaf.region: undefined field: global:
-                  //     ./issue3940.cue:98:18
-                }
-              }
-            }
-            #export: (#struct){
-              #conf: (#struct){
-              }
-              _objects: (#struct){
-                leaf: (#struct){
-                  #conf: (#struct){
-                  }
-                  region: (_|_){
-                    // [incomplete] issue3940.full._branch.imports.0.#export._objects.leaf.region: undefined field: global:
-                    //     ./issue3940.cue:98:18
-                  }
-                }
-              }
-              _imports: (list){
-              }
-              objects: (#list){
-                0: (#struct){
-                  leaf: (#struct){
-                    #conf: (#struct){
-                    }
-                    region: (_|_){
-                      // [incomplete] issue3940.full._branch.imports.0.#export.objects.0.leaf.region: undefined field: global:
-                      //     ./issue3940.cue:98:18
-                    }
-                  }
-                }
-              }
-            }
-          }
-        }
-        #export: (#struct){
-          #conf: (#struct){
-          }
+          0: ~(issue3940.full._leaf)
+        }
+        #export: (#struct){
           _objects: (#struct){
             branch: (#struct){
               #conf: (#struct){
@@ -453,8 +403,6 @@
                 }
               }
               #export: (#struct){
-                #conf: (#struct){
-                }
                 _objects: (#struct){
                   leaf: (#struct){
                     #conf: (#struct){
@@ -465,6 +413,8 @@
                     }
                   }
                 }
+                #conf: (#struct){
+                }
                 _imports: (list){
                 }
                 objects: (#list){
@@ -482,6 +432,8 @@
               }
             }
           }
+          #conf: (#struct){
+          }
           objects: (#list){
             0: (#struct){
               branch: (#struct){
@@ -518,8 +470,6 @@
           }
         }
         #export: (#struct){
-          #conf: (#struct){
-          }
           _objects: (#struct){
             leaf: (#struct){
               #conf: (#struct){
@@ -530,6 +480,8 @@
               }
             }
           }
+          #conf: (#struct){
+          }
           _imports: (list){
           }
           objects: (#list){
@@ -558,45 +510,20 @@
       }
     }
   }
-  issue3990: (struct){
+  issue3990: (_|_){
+    // [eval] exportObjs.deployment._names: adding field data not allowed as field set was already referenced:
+    //     ./issue3990.cue:22:15
     _imports: (#list){
-      0: (struct){
-        name: (string){ "noVolumes" }
-        exportObjs: (struct){
-          deployment: (struct){
-            _names: (struct){
-            }
-            volumes: (#list){
-            }
-          }
-        }
-      }
-      1: (struct){
-        name: (string){ "someVolumes" }
-        exportObjs: (struct){
-          deployment: (struct){
-            _names: (struct){
-              data: (string){ "data" }
-            }
-            volumeNames: (#list){
-              0: (string){ "data" }
-            }
-            volumes: (#list){
-              0: (struct){
-                name: (string){ "data" }
-              }
-            }
-          }
-        }
-      }
+      0: ~(issue3990._noVolumes)
+      1: ~(issue3990._someVolumes)
     }
     _noVolumes: (struct){
       name: (string){ "noVolumes" }
       exportObjs: (struct){
         deployment: (struct){
-          _names: (struct){
-          }
-          volumes: (#list){
+          volumes: (#list){
+          }
+          _names: (struct){
           }
         }
       }
@@ -605,6 +532,11 @@
       name: (string){ "someVolumes" }
       exportObjs: (struct){
         deployment: (struct){
+          volumes: (#list){
+            0: (struct){
+              name: (string){ "data" }
+            }
+          }
           _names: (struct){
             data: (string){ "data" }
           }
@@ -611,11 +543,6 @@
           volumeNames: (#list){
             0: (string){ "data" }
           }
-          volumes: (#list){
-            0: (struct){
-              name: (string){ "data" }
-            }
-          }
         }
       }
     }
@@ -627,25 +554,6 @@
         //     ./issue3990.cue:21:21
       }
     }
-    noVolumes: (struct){
-      _names: (struct){
-      }
-      volumes: (#list){
-      }
-    }
-    someVolumes: (struct){
-      _names: (struct){
-        data: (string){ "data" }
-      }
-      volumeNames: (#list){
-        0: (string){ "data" }
-      }
-      volumes: (#list){
-        0: (struct){
-          name: (string){ "data" }
-        }
-      }
-    }
   }
   T: (int){ 1 }
   let X#1multi = 〈1;C〉.M
-- out/eval --
(struct){
  given: (struct){
    INC: (struct){
      USD: (float){ 2.0 }
    }
    USD: (struct){
      GBP: (float){ 3.0 }
    }
  }
  hydrated: (struct){
    INC: (struct){
      INC: (float){ 1.0 }
      USD: (float){ 2.0 }
    }
    USD: (struct){
      USD: (float){ 1.0 }
      INC: (number){ number }
      GBP: (float){ 3.0 }
    }
    GBP: (struct){
      GBP: (float){ 1.0 }
      USD: (number){ number }
    }
  }
  foo: (struct){
    a: (int){ 10 }
    b: (int){ 20 }
  }
  indirectlyNested: (struct){
    a: (bool){ true }
    b: (bool){ true }
  }
  directlyNestedEmpty: (struct){
    a: (bool){ true }
  }
  directlyDoublyNestedEmpty: (struct){
    a: (bool){ true }
  }
  indirectlyDoublyNestedEmpty: (struct){
    a: (bool){ true }
    b: (bool){ true }
  }
  indirectlyDoublyNested: (struct){
    a: (bool){ true }
    c: (int){ 1 }
    b: (int){ 1 }
  }
  issue1974: (struct){
    X: (struct){
      foo: (struct){
        bar: (string){ "" }
        baz: (string){ "" }
      }
    }
    out: (struct){
      foo: (struct){
        bar: (string){ "" }
        baz: (string){ "" }
      }
    }
  }
  issue3940: (struct){
    reduced1: (struct){
      a: (struct){
        b: (struct){
          a: (struct){
            b: (struct){
              y: (struct){
                a: (struct){
                }
                objects: (struct){
                }
              }
            }
          }
          objects: (_|_){
            // [incomplete] issue3940.reduced1.a.b.objects: undefined field: objects:
            //     ./issue3940.cue:12:22
          }
        }
      }
      X: (struct){
        a: (struct){
        }
        objects: (struct){
        }
      }
      objects: (_|_){
        // [incomplete] objects: undefined field: objects:
        //     ./issue3940.cue:12:22
      }
    }
    reduced2: (struct){
      a: (struct){
        b: (struct){
          a: (struct){
            b: (struct){
              y: (struct){
                a: (struct){
                }
                objects: (struct){
                }
              }
            }
          }
          objects: (_|_){
            // [incomplete] issue3940.reduced2.a.b.objects: undefined field: objects:
            //     ./issue3940.cue:29:22
          }
        }
      }
      X: (struct){
        a: (struct){
        }
        objects: (struct){
        }
      }
      objects: (_|_){
        // [incomplete] objects: undefined field: objects:
        //     ./issue3940.cue:29:22
      }
    }
    reduced3: (struct){
      a: (struct){
        i: (struct){
          x: (struct){
            i: (struct){
              x: (struct){
                i: (struct){
                }
                o: (#list){
                }
              }
            }
            o: (#list){
            }
          }
        }
        o: (#list){
        }
      }
      E: (struct){
        i: (struct){
        }
        o: (#list){
        }
      }
    }
    reduced4: (struct){
      out: (struct){
        _imports: (#list){
          0: (struct){
            objects: (struct){
            }
            #export: (#struct){
              _imports: (#list){
                0: (#struct){
                  #export: (#struct){
                    _imports: (list){
                    }
                    objects: (#list){
                    }
                  }
                }
              }
              objects: (#list){
              }
            }
          }
        }
        objects: (#list){
        }
      }
      Exporter: (struct){
        _imports: (list){
        }
        objects: (#list){
        }
      }
    }
    let: (struct){
      a: (struct){
        b: (struct){
          a: (struct){
            b: (struct){
              y: (struct){
                a: (struct){
                }
                objects: (struct){
                }
              }
            }
          }
          objects: (_|_){
            // [incomplete] issue3940.let.a.b.objects: undefined field: objects:
            //     ./issue3940.cue:73:15
          }
        }
      }
      X: (struct){
        a: (struct){
        }
        objects: (struct){
        }
      }
      objects: (_|_){
        // [incomplete] objects: undefined field: objects:
        //     ./issue3940.cue:73:15
      }
    }
    full: (struct){
      out: (#struct){
        #conf: (#struct){
          global: (#struct){
            region: (string){ "Europe" }
          }
        }
        _objects: (#struct){
        }
        _imports: (#list){
          0: (struct){
            objects: (struct){
              branch: (struct){
                #conf: (#struct){
                }
                region: (_|_){
                  // [incomplete] issue3940.full.out._imports.0.objects.branch.region: undefined field: global:
                  //     ./issue3940.cue:87:18
                }
              }
            }
            imports: (#list){
              0: (struct){
                objects: (struct){
                  leaf: (struct){
                    #conf: (#struct){
                    }
                    region: (_|_){
                      // [incomplete] issue3940.full.out._imports.0.imports.0.objects.leaf.region: undefined field: global:
                      //     ./issue3940.cue:98:18
                    }
                  }
                }
                #export: (#struct){
                  #conf: (#struct){
                  }
                  _objects: (#struct){
                    leaf: (#struct){
                      #conf: (#struct){
                      }
                      region: (_|_){
                        // [incomplete] issue3940.full.out._imports.0.imports.0.#export._objects.leaf.region: undefined field: global:
                        //     ./issue3940.cue:98:18
                      }
                    }
                  }
                  _imports: (list){
                  }
                  objects: (#list){
                    0: (#struct){
                      leaf: (#struct){
                        #conf: (#struct){
                        }
                        region: (_|_){
                          // [incomplete] issue3940.full.out._imports.0.imports.0.#export.objects.0.leaf.region: undefined field: global:
                          //     ./issue3940.cue:98:18
                        }
                      }
                    }
                  }
                }
              }
            }
            #export: (#struct){
              #conf: (#struct){
              }
              _objects: (#struct){
                branch: (#struct){
                  #conf: (#struct){
                  }
                  region: (_|_){
                    // [incomplete] issue3940.full.out._imports.0.#export._objects.branch.region: undefined field: global:
                    //     ./issue3940.cue:87:18
                  }
                }
              }
              _imports: (#list){
                0: (#struct){
                  objects: (#struct){
                    leaf: (#struct){
                      #conf: (#struct){
                      }
                      region: (_|_){
                        // [incomplete] issue3940.full.out._imports.0.#export._imports.0.objects.leaf.region: undefined field: global:
                        //     ./issue3940.cue:98:18
                      }
                    }
                  }
                  #export: (#struct){
                    #conf: (#struct){
                    }
                    _objects: (#struct){
                      leaf: (#struct){
                        #conf: (#struct){
                        }
                        region: (_|_){
                          // [incomplete] issue3940.full.out._imports.0.#export._imports.0.#export._objects.leaf.region: undefined field: global:
                          //     ./issue3940.cue:98:18
                        }
                      }
                    }
                    _imports: (list){
                    }
                    objects: (#list){
                      0: (#struct){
                        leaf: (#struct){
                          #conf: (#struct){
                          }
                          region: (_|_){
                            // [incomplete] issue3940.full.out._imports.0.#export._imports.0.#export.objects.0.leaf.region: undefined field: global:
                            //     ./issue3940.cue:98:18
                          }
                        }
                      }
                    }
                  }
                }
              }
              objects: (#list){
                0: (#struct){
                  branch: (#struct){
                    #conf: (#struct){
                    }
                    region: (_|_){
                      // [incomplete] issue3940.full.out._imports.0.#export.objects.0.branch.region: undefined field: global:
                      //     ./issue3940.cue:87:18
                    }
                  }
                }
                1: (#struct){
                  leaf: (#struct){
                    #conf: (#struct){
                    }
                    region: (_|_){
                      // [incomplete] issue3940.full.out._imports.0.#export.objects.1.leaf.region: undefined field: global:
                      //     ./issue3940.cue:98:18
                    }
                  }
                }
              }
            }
          }
        }
        objects: (#list){
          0: (#struct){
            branch: (#struct){
              #conf: (#struct){
                global: (#struct){
                  region: (string){ "Europe" }
                }
              }
              region: (string){ "Europe" }
            }
          }
          1: (#struct){
            leaf: (#struct){
              #conf: (#struct){
                global: (#struct){
                  region: (string){ "Europe" }
                }
              }
              region: (string){ "Europe" }
            }
          }
        }
      }
      _branch: (struct){
        objects: (struct){
          branch: (struct){
            #conf: (#struct){
            }
            region: (_|_){
              // [incomplete] issue3940.full._branch.objects.branch.region: undefined field: global:
              //     ./issue3940.cue:87:18
            }
          }
        }
        imports: (#list){
          0: (struct){
            objects: (struct){
              leaf: (struct){
                #conf: (#struct){
                }
                region: (_|_){
                  // [incomplete] issue3940.full._branch.imports.0.objects.leaf.region: undefined field: global:
                  //     ./issue3940.cue:98:18
                }
              }
            }
            #export: (#struct){
              #conf: (#struct){
              }
              _objects: (#struct){
                leaf: (#struct){
                  #conf: (#struct){
                  }
                  region: (_|_){
                    // [incomplete] issue3940.full._branch.imports.0.#export._objects.leaf.region: undefined field: global:
                    //     ./issue3940.cue:98:18
                  }
                }
              }
              _imports: (list){
              }
              objects: (#list){
                0: (#struct){
                  leaf: (#struct){
                    #conf: (#struct){
                    }
                    region: (_|_){
                      // [incomplete] issue3940.full._branch.imports.0.#export.objects.0.leaf.region: undefined field: global:
                      //     ./issue3940.cue:98:18
                    }
                  }
                }
              }
            }
          }
        }
        #export: (#struct){
          #conf: (#struct){
          }
          _objects: (#struct){
            branch: (#struct){
              #conf: (#struct){
              }
              region: (_|_){
                // [incomplete] issue3940.full._branch.#export._objects.branch.region: undefined field: global:
                //     ./issue3940.cue:87:18
              }
            }
          }
          _imports: (#list){
            0: (#struct){
              objects: (#struct){
                leaf: (#struct){
                  #conf: (#struct){
                  }
                  region: (_|_){
                    // [incomplete] issue3940.full._branch.#export._imports.0.objects.leaf.region: undefined field: global:
                    //     ./issue3940.cue:98:18
                  }
                }
              }
              #export: (#struct){
                #conf: (#struct){
                }
                _objects: (#struct){
                  leaf: (#struct){
                    #conf: (#struct){
                    }
                    region: (_|_){
                      // [incomplete] issue3940.full._branch.#export._imports.0.#export._objects.leaf.region: undefined field: global:
                      //     ./issue3940.cue:98:18
                    }
                  }
                }
                _imports: (list){
                }
                objects: (#list){
                  0: (#struct){
                    leaf: (#struct){
                      #conf: (#struct){
                      }
                      region: (_|_){
                        // [incomplete] issue3940.full._branch.#export._imports.0.#export.objects.0.leaf.region: undefined field: global:
                        //     ./issue3940.cue:98:18
                      }
                    }
                  }
                }
              }
            }
          }
          objects: (#list){
            0: (#struct){
              branch: (#struct){
                #conf: (#struct){
                }
                region: (_|_){
                  // [incomplete] issue3940.full._branch.#export.objects.0.branch.region: undefined field: global:
                  //     ./issue3940.cue:87:18
                }
              }
            }
            1: (#struct){
              leaf: (#struct){
                #conf: (#struct){
                }
                region: (_|_){
                  // [incomplete] issue3940.full._branch.#export.objects.1.leaf.region: undefined field: global:
                  //     ./issue3940.cue:98:18
                }
              }
            }
          }
        }
      }
      _leaf: (struct){
        objects: (struct){
          leaf: (struct){
            #conf: (#struct){
            }
            region: (_|_){
              // [incomplete] issue3940.full._leaf.objects.leaf.region: undefined field: global:
              //     ./issue3940.cue:98:18
            }
          }
        }
        #export: (#struct){
          #conf: (#struct){
          }
          _objects: (#struct){
            leaf: (#struct){
              #conf: (#struct){
              }
              region: (_|_){
                // [incomplete] issue3940.full._leaf.#export._objects.leaf.region: undefined field: global:
                //     ./issue3940.cue:98:18
              }
            }
          }
          _imports: (list){
          }
          objects: (#list){
            0: (#struct){
              leaf: (#struct){
                #conf: (#struct){
                }
                region: (_|_){
                  // [incomplete] issue3940.full._leaf.#export.objects.0.leaf.region: undefined field: global:
                  //     ./issue3940.cue:98:18
                }
              }
            }
          }
        }
      }
      #Exporter: (#struct){
        #conf: (#struct){
        }
        _objects: (#struct){
        }
        _imports: (list){
        }
        objects: (#list){
        }
      }
    }
  }
  issue3990: (struct){
    _imports: (#list){
      0: (struct){
        name: (string){ "noVolumes" }
        exportObjs: (struct){
          deployment: (struct){
            _names: (struct){
            }
            volumes: (#list){
            }
          }
        }
      }
      1: (struct){
        name: (string){ "someVolumes" }
        exportObjs: (struct){
          deployment: (struct){
            _names: (struct){
              data: (string){ "data" }
            }
            volumeNames: (#list){
              0: (string){ "data" }
            }
            volumes: (#list){
              0: (struct){
                name: (string){ "data" }
              }
            }
          }
        }
      }
    }
    _noVolumes: (struct){
      name: (string){ "noVolumes" }
      exportObjs: (struct){
        deployment: (struct){
          _names: (struct){
          }
          volumes: (#list){
          }
        }
      }
    }
    _someVolumes: (struct){
      name: (string){ "someVolumes" }
      exportObjs: (struct){
        deployment: (struct){
          _names: (struct){
            data: (string){ "data" }
          }
          volumeNames: (#list){
            0: (string){ "data" }
          }
          volumes: (#list){
            0: (struct){
              name: (string){ "data" }
            }
          }
        }
      }
    }
    _Deployment: (_|_){
      // [incomplete] issue3990._Deployment._names: undefined field: volumes:
      //     ./issue3990.cue:21:21
      _names: (_|_){
        // [incomplete] issue3990._Deployment._names: undefined field: volumes:
        //     ./issue3990.cue:21:21
      }
    }
    noVolumes: (struct){
      _names: (struct){
      }
      volumes: (#list){
      }
    }
    someVolumes: (struct){
      _names: (struct){
        data: (string){ "data" }
      }
      volumeNames: (#list){
        0: (string){ "data" }
      }
      volumes: (#list){
        0: (struct){
          name: (string){ "data" }
        }
      }
    }
  }
  T: (int){ 1 }
  let X#1multi = 〈1;C〉.M
  Y: (struct){
    x: (struct){
      M: (struct){
        V: (int){ 1 }
      }
    }
  }
}
-- out/compile --
--- in.cue
{
  given: {
    INC: {
      USD: 2.0
    }
    USD: {
      GBP: 3.0
    }
  }
  hydrated: {
    for k, v in 〈1;given〉 {
      for k1, r in 〈1;v〉 {
        "\(〈3;k〉)": {
          "\(〈4;k〉)": 1.0
        }
        "\(〈1;k1〉)": {
          "\(〈2;k1〉)": 1.0
        }
        "\(〈3;k〉)": {
          "\(〈2;k1〉)": 〈2;r〉
        }
        "\(〈1;k1〉)": {
          "\(〈4;k〉)": number
        }
      }
    }
  }
  foo: {
    a: 10
    if (〈0;a〉 < 20) {
      if (〈1;a〉 < 50) {
        b: 20
      }
    }
  }
  indirectlyNested: {
    a: true
    if true {
      b: {
        if 〈2;a〉 {
          〈3;a〉
        }
      }
    }
  }
  directlyNestedEmpty: {
    a: true
    if true {
      if 〈1;a〉 {}
    }
  }
  directlyDoublyNestedEmpty: {
    a: true
    if true {
      if 〈1;a〉 {}
    }
  }
  indirectlyDoublyNestedEmpty: {
    a: true
    b: {
      if true {
        if 〈2;a〉 {
          if 〈3;a〉 {
            〈4;a〉
          }
        }
        if 〈2;a〉 {
          〈3;a〉
        }
      }
    }
  }
  indirectlyDoublyNested: {
    a: true
    if true {
      if 〈1;a〉 {
        if 〈2;a〉 {
          b: 1
        }
      }
      if 〈1;a〉 {
        c: 1
      }
    }
  }
  issue1974: {
    X: {
      foo: {
        bar: ""
        baz: ""
      }
    }
    out: {
      for k, v in 〈1;X〉 for vk, vv in 〈0;v〉 {
        "\(〈2;k〉)": {
          "\(〈2;vk〉)": 〈2;vv〉
        }
      }
    }
  }
}
--- issue3940.cue
{
  issue3940: {
    reduced1: {
      〈0;X〉
      a: {
        b: 〈1;X〉
      }
      a: {
        b: {
          a: {
            b: {
              y: 〈4;X〉
            }
          }
        }
      }
      X: {
        a: {}
        objects: {
          for _, v in 〈1;a〉 for _, _ in ({} & 〈0;v〉).objects {}
        }
      }
    }
  }
  issue3940: {
    reduced2: {
      〈0;X〉
      a: {
        b: 〈1;X〉
      }
      a: {
        b: {
          a: {
            b: {
              y: 〈4;X〉
            }
          }
        }
      }
      X: {
        a: {}
        objects: {
          for _, v in 〈1;a〉 for _, _ in ({} & 〈0;v〉).objects {}
        }
      }
    }
  }
  issue3940: {
    reduced3: {
      a: 〈0;E〉
      a: {
        i: {
          x: 〈2;E〉
        }
      }
      a: {
        i: {
          x: {
            i: {
              x: 〈4;E〉
            }
          }
        }
      }
      E: {
        i: {}
        o: [
          for _, m in 〈1;i〉 for _, v in ({} & 〈0;m〉).o {},
        ]
      }
    }
  }
  issue3940: {
    reduced4: {
      out: (〈0;Exporter〉 & {
        _imports: [
          {
            objects: {
              ...
            }
            #export: (〈3;Exporter〉 & {
              _imports: [
                {
                  #export: 〈6;Exporter〉
                },
              ]
            })
          },
        ]
      })
      Exporter: {
        _imports: [
          ...,
        ]
        objects: [
          for _, v in 〈1;_imports〉 for _, obj in ({} & 〈0;v〉.#export).objects {
            〈1;obj〉
          },
        ]
      }
    }
  }
  issue3940: {
    let: {
      〈0;X〉
      a: {
        b: 〈1;X〉
      }
      a: {
        b: {
          a: {
            b: {
              y: 〈4;X〉
            }
          }
        }
      }
      X: {
        a: {}
        objects: {
          for _, v in 〈1;a〉 let x = ({} & 〈0;v〉) for _, _ in 〈0;x〉.objects {}
        }
      }
    }
  }
  issue3940: {
    full: {
      out: (〈0;#Exporter〉 & {
        _imports: [
          〈2;_branch〉,
        ]
        #conf: {
          global: {
            region: "Europe"
          }
        }
      })
      _branch: {
        objects: {
          branch: {
            #conf: {
              ...
            }
            region: 〈0;#conf〉.global.region
          }
        }
        imports: [
          〈2;_leaf〉,
        ]
        #export: (〈1;#Exporter〉 & {
          _objects: 〈1;objects〉
          _imports: 〈1;imports〉
        })
      }
      _leaf: {
        objects: {
          leaf: {
            #conf: {
              ...
            }
            region: 〈0;#conf〉.global.region
          }
        }
        #export: (〈1;#Exporter〉 & {
          _objects: 〈1;objects〉
        })
      }
      #Exporter: {
        #conf: {
          ...
        }
        _objects: {
          ...
        }
        _imports: [
          ...,
        ]
        objects: [
          for name, obj in (〈1;_objects〉 & {
            [string]: {
              #conf: 〈3;#conf〉
            }
          }) {
            〈1;name〉: 〈1;obj〉
          },
          for _, import in 〈1;_imports〉 for _, obj in ({
            #conf: 〈3;#conf〉
          } & 〈0;import〉.#export).objects {
            〈1;obj〉
          },
        ]
      }
    }
  }
}
--- issue3990.cue
{
  issue3990: {
    _imports: [
      〈1;_noVolumes〉,
      〈1;_someVolumes〉,
    ]
    _noVolumes: {
      name: "noVolumes"
      exportObjs: {
        deployment: (〈2;_Deployment〉 & {
          volumes: []
        })
      }
    }
    _someVolumes: {
      name: "someVolumes"
      exportObjs: {
        deployment: (〈2;_Deployment〉 & {
          volumes: [
            {
              name: "data"
            },
          ]
        })
      }
    }
    for _, import in 〈0;_imports〉 for _, obj in ({
      extra: "unused"
    } & 〈0;import〉).exportObjs {
      〈2;import〉.name: 〈1;obj〉
    }
    _Deployment: {
      _names: {
        for _, v in 〈2〉.volumes {
          〈1;v〉.name: 〈1;v〉.name
        }
      }
      if (len(〈0;_names〉) > 0) {
        volumeNames: [
          for _, v in 〈2;_names〉 {
            〈1;v〉
          },
        ]
      }
    }
  }
}
--- pending.cue
{
  T: int
  for _, C in 〈0;Y〉 {
    let X#1multi = 〈1;C〉.M
    T: 〈0;let X#1〉.V
  }
  Y: {
    x: {
      M: {
        V: 1
      }
      for _, _ in 〈0;M〉 {
        if true {
          M: {}
        }
      }
    }
  }
}
