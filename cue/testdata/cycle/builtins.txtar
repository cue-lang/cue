-- in.cue --
import "regexp"

// Issue #655
// When evaluating a value into a struct, and then back into a value, the
// evaluation mode flips from Partial to AllConjunctsDone to Back. This is
// typically not an issue, but if a referred field is within a struct generated
// by a builtin, effectively the entire struct needs to be evaluated and special
// care should be taking to not evaluate too early.
builtinCyclePerm0: {
	X: "mod.test"

	Y: {
		#components: regexp.FindNamedSubmatch(#"^(?P<host>[[:alnum:].]+)$"#, X)
		host:        #components.host
	}

	X: Y.host
}

builtinCyclePerm1: {
	X: Y.host

	Y: {
		#components: regexp.FindNamedSubmatch(#"^(?P<host>[[:alnum:].]+)$"#, X)
		host:        #components.host
	}

	X: "mod.test"
}

builtinCyclePerm2: {
	Y: {
		#components: regexp.FindNamedSubmatch(#"^(?P<host>[[:alnum:].]+)$"#, X)
		host:        #components.host
	}

	X: Y.host
	X: "mod.test"
}

builtinCyclePerm3: {
	Y: {
		#components: regexp.FindNamedSubmatch(#"^(?P<host>[[:alnum:].]+)$"#, X)
		host:        #components.host
	}

	X: "mod.test"
	X: Y.host
}

builtinCyclePerm4: {
	X: "mod.test"
	X: Y.host

	Y: {
		#components: regexp.FindNamedSubmatch(#"^(?P<host>[[:alnum:].]+)$"#, X)
		host:        #components.host
	}
}

builtinCyclePerm5: {
	X: Y.host
	X: "mod.test"

	Y: {
		#components: regexp.FindNamedSubmatch(#"^(?P<host>[[:alnum:].]+)$"#, X)
		host:        #components.host
	}
}
-- matchn.cue --
// This should not be a structural cycle, as the list type is "optional".
issue3410: {
	_s
	_s: {
		#x: matchN(1, [_s, [..._s]])
	}
}
issue3420: {
	matches1: {
		#S: matchN(1, [_, _|_])
		s: 2
	}
}
issue3443: {
	matchIf: {
		#S: matchIf({x?: "b"}, {n?: #S & (int | {})}, _)
	}
	noCycle: {
		// This is not a structural cycle, and should not hang, as n? is optional.
		#S: matchN(1, [{n?: #S & (int | {})}])

		noHang: {
			s: #S
			s: n: n: _
		}
	}

	noCycle2: {
		#S: matchN(1, [{n?: (int | #S)}])
	}

	cycle1: {
		// This correct CUE, as matchN allows for schema to be errors. We should
		// probably have a vet rule to catch this,though.
		#S: matchN(1, [{n: #S}])

		// This is not an error as the result is structure shared. Not sure if
		// this should be accepted.
		ok: {
			s: #S
			s: _
		}

		// This unifies deep enough to cause a structural cycle. It probably
		// should not.
		cycle: {
			s: #S
			s: n: n: _
		}
	}

	cycle2: {
		// TODO: this should probably fail, or at least be consistent with
		// cycle1.cycle.
		fail: #S: matchN(1, [{n: #S}]) & {n: n: n: _}
	}
}
issue3633: final: {
	// With nested matchNs as below, the schema will become an incomplete error
	// as a value of the root vertex. Make sure this edge case is properly
	// handled.
	data: {} & #s
	#s: matchN(1, [matchN(1, [{a!: _}])])
}
-- cycle.cue --
import "encoding/yaml"

noCycle: t1: {
	_s
	_s: {
		#x: matchN(1, [_s])
        #x: {} // insert concrete value to trigger application of validator.
	}
}
issue3649: noCycle: t1: {
	data: #c
	data: a: b: "foo"
	#c: {
		// There should be no cycle because of these optional fields.
		b?: string
		a?: matchN(1, [#c])
	}
}
// Same as above, but with longer paths.
issue3649: noCycle: t2: {
	x: c
	x: y: a: d: b: "foo"
	c: {
		b?: string
		y: a?: matchN(1, [{d: c}])
	}
}
issue3649: cycle: t1: {
	data: #c
	data: a: b: "foo"
	#c: {
		b: string
		a: matchN(1, [#c])
	}
}
yamlNoCycle: {
	// the validator is invoked recursively and also unifies with a concrete
	// value. This should nonetheless not result in a cycle error.
    #c: {
        b?: string
        a?: yaml.Validate(#c)
    }
    data: #c
    data: a: #"{a: "b: foo"}"#
}
selfCycle: t1: {
	c: matchN(1, [{d: c}])
	c: d: {}
}
selfCycle: t2: {
	// Even though only part of the path is unified with concrete data, this
	// should still result in a cycle error.
	c: matchN(1, [{d: c}])
	c: {}
}
// TODO: fix hang
// selfCycle: yamlVal: t1: {
// 	x: y: yaml.Validate(x)
// 	x: y: "{}"
// }
// selfCycle: yamlVal: t1: {
// 	x: y: yaml.Validate(x)
// 	x: y: "{}"
// }
// selfCycle: yamlFun: t1:{
// 	x: y?: yaml.Validate("{}", x)
// }
// selfCycle: yamlFun: t2: {
// 	z: x & __no_sharing
// 	z: y: "{}"
// 	x: y: yaml.Validate("{}", x)
// }
-- todo/p1 --
issue3443.noCycle: fix hang
-- out/evalalpha/stats --
Leaks:  352
Freed:  17
Reused: 17
Allocs: 352
Retain: 0

Unifications: 309
Conjuncts:    1189
Disjuncts:    28
-- diff/-out/evalalpha/stats<==>+out/eval/stats --
diff old new
--- old
+++ new
@@ -1,9 +1,9 @@
-Leaks:  22
-Freed:  369
-Reused: 357
-Allocs: 34
-Retain: 95
+Leaks:  352
+Freed:  17
+Reused: 17
+Allocs: 352
+Retain: 0
 
-Unifications: 363
-Conjuncts:    645
-Disjuncts:    454
+Unifications: 309
+Conjuncts:    1189
+Disjuncts:    28
-- out/eval/stats --
Leaks:  22
Freed:  369
Reused: 357
Allocs: 34
Retain: 95

Unifications: 363
Conjuncts:    645
Disjuncts:    454
-- out/evalalpha --
Errors:
noCycle.t1.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:6:7
    ./cycle.cue:6:14
    ./cycle.cue:7:13
noCycle.t1.#x.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:6:7
    ./cycle.cue:6:14
    ./cycle.cue:7:13
noCycle.t1._s.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:6:7
    ./cycle.cue:6:14
    ./cycle.cue:7:13
noCycle.t1._s.#x.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:6:7
    ./cycle.cue:6:14
    ./cycle.cue:7:13
selfCycle.t1.c: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:47:5
    ./cycle.cue:47:12
    ./cycle.cue:48:5
selfCycle.t1.c.d: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:47:5
    ./cycle.cue:47:12
    ./cycle.cue:47:20
    ./cycle.cue:48:8
selfCycle.t1.c.d.d: structural cycle:
    ./cycle.cue:47:5
selfCycle.t2.c: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:53:5
    ./cycle.cue:53:12
    ./cycle.cue:54:5
selfCycle.t2.c.d: structural cycle:
    ./cycle.cue:53:5
issue3443.matchIf.#S: cannot call non-function matchIf (type struct):
    ./matchn.cue:16:7
issue3443.cycle1.cycle.s: invalid value {n:{n:_}} (does not satisfy matchN): 0 matched, expected 1:
    ./matchn.cue:35:7
    ./matchn.cue:35:14
    ./matchn.cue:47:7
    ./matchn.cue:48:7
issue3443.cycle1.cycle.s.n: invalid value {n:_} (does not satisfy matchN): 0 matched, expected 1:
    ./matchn.cue:35:7
    ./matchn.cue:35:14
    ./matchn.cue:35:22
    ./matchn.cue:48:10
issue3443.cycle1.cycle.s.n.n: structural cycle:
    ./matchn.cue:35:7
issue3443.cycle2.fail.#S: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
    ./matchn.cue:55:13
    ./matchn.cue:55:20
issue3443.cycle2.fail.#S.n: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
    ./matchn.cue:55:13
    ./matchn.cue:55:20
    ./matchn.cue:55:28
    ./matchn.cue:55:40
issue3443.cycle2.fail.#S.n.n: structural cycle:
    ./matchn.cue:55:13

Result:
(_|_){
  // [eval]
  noCycle: (_|_){
    // [eval]
    t1: (_|_){
      // [eval]
      _s: (_|_){
        // [eval]
        #x: (_|_){
          // [eval] noCycle.t1._s.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
          //     ./cycle.cue:6:7
          //     ./cycle.cue:6:14
          //     ./cycle.cue:7:13
          // noCycle.t1._s.#x.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
          //     ./cycle.cue:6:7
          //     ./cycle.cue:6:14
          //     ./cycle.cue:7:13
        }
      }
      #x: (_|_){
        // [eval] noCycle.t1.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:6:7
        //     ./cycle.cue:6:14
        //     ./cycle.cue:7:13
        // noCycle.t1.#x.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:6:7
        //     ./cycle.cue:6:14
        //     ./cycle.cue:7:13
      }
    }
  }
  issue3649: (struct){
    noCycle: (struct){
      t1: (struct){
        data: (#struct){
          a: (#struct){
            b: (string){ "foo" }
          }
          b?: (string){ string }
        }
        #c: (#struct){
          b?: (string){ string }
          a?: (_){ matchN(1, (#list){
              0: (_|_){// &[〈2;#c〉]
              }
            }) }
        }
      }
      t2: (struct){
        x: (struct){
          y: (struct){
            a: (struct){
              d: (struct){
                b: (string){ "foo" }
              }
            }
          }
          b?: (string){ string }
        }
        c: (struct){
          b?: (string){ string }
          y: (struct){
            a?: (_){ matchN(1, (#list){
                0: (_|_){// &[{
                  //   d: 〈4;c〉
                  // }]
                }
              }) }
          }
        }
      }
    }
    cycle: (struct){
      t1: (struct){
        data: (#struct){
          a: (#struct){
            b: (string){ "foo" }
          }
          b: (string){ string }
        }
        #c: (#struct){
          b: (string){ string }
          a: (_){ matchN(1, (#list){
              0: (_|_){// &[〈2;#c〉]
              }
            }) }
        }
      }
    }
  }
  yamlNoCycle: (struct){
    #c: (#struct){
      b?: (string){ string }
      a?: ((string|bytes)){ "encoding/yaml".Validate(yamlNoCycle.#c) }
    }
    data: (#struct){
      a: (string){ "{a: \"b: foo\"}" }
      b?: (string){ string }
    }
  }
  selfCycle: (_|_){
    // [eval]
    t1: (_|_){
      // [eval]
      c: (_|_){
        // [eval] selfCycle.t1.c: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:47:5
        //     ./cycle.cue:47:12
        //     ./cycle.cue:48:5
        // selfCycle.t1.c.d: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:47:5
        //     ./cycle.cue:47:12
        //     ./cycle.cue:47:20
        //     ./cycle.cue:48:8
        // selfCycle.t1.c.d.d: structural cycle:
        //     ./cycle.cue:47:5
        d: (struct){
        }
      }
    }
    t2: (_|_){
      // [eval]
      c: (_|_){
        // [eval] selfCycle.t2.c: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:53:5
        //     ./cycle.cue:53:12
        //     ./cycle.cue:54:5
        // selfCycle.t2.c.d: structural cycle:
        //     ./cycle.cue:53:5
      }
    }
  }
  builtinCyclePerm0: (struct){
    X: (string){ "mod.test" }
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
  }
  builtinCyclePerm1: (struct){
    X: (string){ "mod.test" }
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
  }
  builtinCyclePerm2: (struct){
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
    X: (string){ "mod.test" }
  }
  builtinCyclePerm3: (struct){
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
    X: (string){ "mod.test" }
  }
  builtinCyclePerm4: (struct){
    X: (string){ "mod.test" }
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
  }
  builtinCyclePerm5: (struct){
    X: (string){ "mod.test" }
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
  }
  issue3410: (struct){
    _s: (struct){
      #x: (_){ matchN(1, (#list){
          0: (_|_){// &[〈2;_s〉]
          }
          1: (_|_){// &[[
            //   ...〈3;_s〉,
            // ]]
          }
        }) }
    }
    #x: (_){ matchN(1, (#list){
        0: (_|_){// &[〈2;_s〉]
        }
        1: (_|_){// &[[
          //   ...〈3;_s〉,
          // ]]
        }
      }) }
  }
  issue3420: (struct){
    matches1: (struct){
      #S: (_){ matchN(1, (#list){
          0: (_|_){// &[_]
          }
          1: (_|_){// &[_|_(explicit error (_|_ literal) in source)]
          }
        }) }
      s: (int){ 2 }
    }
  }
  issue3443: (_|_){
    // [eval]
    matchIf: (_|_){
      // [eval]
      #S: (_|_){
        // [eval] issue3443.matchIf.#S: cannot call non-function matchIf (type struct):
        //     ./matchn.cue:16:7
      }
    }
    noCycle: (struct){
      #S: (_){ matchN(1, (#list){
          0: (_|_){// &[{
            //   n?: (〈2;#S〉 & (int|{}))
            // }]
          }
        }) }
      noHang: (struct){
        s: (#struct){
          n: (struct){
            n: (_){ _ }
          }
        }
      }
    }
    noCycle2: (struct){
      #S: (_){ matchN(1, (#list){
          0: (_|_){// &[{
            //   n?: (int|〈2;#S〉)
            // }]
          }
        }) }
    }
    cycle1: (_|_){
      // [eval]
      #S: (_){ matchN(1, (#list){
          0: (_|_){// &[{
            //   n: 〈2;#S〉
            // }]
          }
        }) }
      ok: (struct){
        s: (_){ matchN(1, (#list){
            0: (_|_){// &[{
              //   n: 〈2;#S〉
              // }]
            }
          }) }
      }
      cycle: (_|_){
        // [eval]
        s: (_|_){
          // [eval] issue3443.cycle1.cycle.s: invalid value {n:{n:_}} (does not satisfy matchN): 0 matched, expected 1:
          //     ./matchn.cue:35:7
          //     ./matchn.cue:35:14
          //     ./matchn.cue:47:7
          //     ./matchn.cue:48:7
          // issue3443.cycle1.cycle.s.n: invalid value {n:_} (does not satisfy matchN): 0 matched, expected 1:
          //     ./matchn.cue:35:7
          //     ./matchn.cue:35:14
          //     ./matchn.cue:35:22
          //     ./matchn.cue:48:10
          // issue3443.cycle1.cycle.s.n.n: structural cycle:
          //     ./matchn.cue:35:7
          n: (struct){
            n: (_){ _ }
          }
        }
      }
    }
    cycle2: (_|_){
      // [eval]
      fail: (_|_){
        // [eval]
        #S: (_|_){
          // [eval] issue3443.cycle2.fail.#S: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
          //     ./matchn.cue:55:13
          //     ./matchn.cue:55:20
          // issue3443.cycle2.fail.#S.n: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
          //     ./matchn.cue:55:13
          //     ./matchn.cue:55:20
          //     ./matchn.cue:55:28
          //     ./matchn.cue:55:40
          // issue3443.cycle2.fail.#S.n.n: structural cycle:
          //     ./matchn.cue:55:13
          n: (#struct){
            n: (#struct){
              n: (_){ _ }
            }
          }
        }
      }
    }
  }
  issue3633: (struct){
    final: (struct){
      data: (_|_){
        // [incomplete] issue3633.final.data: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./matchn.cue:63:6
        //     ./matchn.cue:62:8
        //     ./matchn.cue:63:13
        // issue3633.final.data: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./matchn.cue:63:17
        //     ./matchn.cue:62:8
        //     ./matchn.cue:63:24
        // issue3633.final.data.a: field is required but not present:
        //     ./matchn.cue:63:17
        //     ./matchn.cue:63:29
      }
      #s: (_){ matchN(1, (#list){
          0: (_|_){// &[matchN(1, [
            //   {
            //     a!: _
            //   },
            // ])]
          }
        }) }
    }
  }
}
-- diff/-out/evalalpha<==>+out/eval --
diff old new
--- old
+++ new
@@ -24,29 +24,28 @@
     ./cycle.cue:47:12
     ./cycle.cue:47:20
     ./cycle.cue:48:8
-selfCycle.t1.c.d.d: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
-    ./cycle.cue:47:5
-    ./cycle.cue:47:12
-    ./cycle.cue:47:20
-    ./cycle.cue:48:8
-selfCycle.t1.c.d.d.d: structural cycle:
+selfCycle.t1.c.d.d: structural cycle:
     ./cycle.cue:47:5
 selfCycle.t2.c: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
     ./cycle.cue:53:5
     ./cycle.cue:53:12
     ./cycle.cue:54:5
-selfCycle.t2.c.d: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
-    ./cycle.cue:53:5
-    ./cycle.cue:53:12
-    ./cycle.cue:53:20
-selfCycle.t2.c.d.d: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
-    ./cycle.cue:53:5
-    ./cycle.cue:53:12
-    ./cycle.cue:53:20
-selfCycle.t2.c.d.d.d: structural cycle:
+selfCycle.t2.c.d: structural cycle:
     ./cycle.cue:53:5
 issue3443.matchIf.#S: cannot call non-function matchIf (type struct):
     ./matchn.cue:16:7
+issue3443.cycle1.cycle.s: invalid value {n:{n:_}} (does not satisfy matchN): 0 matched, expected 1:
+    ./matchn.cue:35:7
+    ./matchn.cue:35:14
+    ./matchn.cue:47:7
+    ./matchn.cue:48:7
+issue3443.cycle1.cycle.s.n: invalid value {n:_} (does not satisfy matchN): 0 matched, expected 1:
+    ./matchn.cue:35:7
+    ./matchn.cue:35:14
+    ./matchn.cue:35:22
+    ./matchn.cue:48:10
+issue3443.cycle1.cycle.s.n.n: structural cycle:
+    ./matchn.cue:35:7
 issue3443.cycle2.fail.#S: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
     ./matchn.cue:55:13
     ./matchn.cue:55:20
@@ -55,13 +54,7 @@
     ./matchn.cue:55:20
     ./matchn.cue:55:28
     ./matchn.cue:55:40
-issue3443.cycle2.fail.#S.n.n: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
-    ./matchn.cue:55:13
-    ./matchn.cue:55:20
-    ./matchn.cue:55:28
-    ./matchn.cue:55:40
-    ./matchn.cue:55:43
-issue3443.cycle2.fail.#S.n.n.n: structural cycle:
+issue3443.cycle2.fail.#S.n.n: structural cycle:
     ./matchn.cue:55:13
 
 Result:
@@ -100,15 +93,15 @@
     noCycle: (struct){
       t1: (struct){
         data: (#struct){
-          b?: (string){ string }
-          a: (struct){
-            b: (string){ "foo" }
-          }
+          a: (#struct){
+            b: (string){ "foo" }
+          }
+          b?: (string){ string }
         }
         #c: (#struct){
           b?: (string){ string }
           a?: (_){ matchN(1, (#list){
-              0: (_|_){// 〈2;#c〉
+              0: (_|_){// &[〈2;#c〉]
               }
             }) }
         }
@@ -115,7 +108,6 @@
       }
       t2: (struct){
         x: (struct){
-          b?: (string){ string }
           y: (struct){
             a: (struct){
               d: (struct){
@@ -123,14 +115,15 @@
               }
             }
           }
+          b?: (string){ string }
         }
         c: (struct){
           b?: (string){ string }
           y: (struct){
             a?: (_){ matchN(1, (#list){
-                0: (_|_){// {
+                0: (_|_){// &[{
                   //   d: 〈4;c〉
-                  // }
+                  // }]
                 }
               }) }
           }
@@ -140,15 +133,15 @@
     cycle: (struct){
       t1: (struct){
         data: (#struct){
-          b: (string){ string }
-          a: (struct){
-            b: (string){ "foo" }
-          }
+          a: (#struct){
+            b: (string){ "foo" }
+          }
+          b: (string){ string }
         }
         #c: (#struct){
           b: (string){ string }
           a: (_){ matchN(1, (#list){
-              0: (_|_){// 〈2;#c〉
+              0: (_|_){// &[〈2;#c〉]
               }
             }) }
         }
@@ -161,8 +154,8 @@
       a?: ((string|bytes)){ "encoding/yaml".Validate(yamlNoCycle.#c) }
     }
     data: (#struct){
-      b?: (string){ string }
       a: (string){ "{a: \"b: foo\"}" }
+      b?: (string){ string }
     }
   }
   selfCycle: (_|_){
@@ -179,12 +172,7 @@
         //     ./cycle.cue:47:12
         //     ./cycle.cue:47:20
         //     ./cycle.cue:48:8
-        // selfCycle.t1.c.d.d: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
-        //     ./cycle.cue:47:5
-        //     ./cycle.cue:47:12
-        //     ./cycle.cue:47:20
-        //     ./cycle.cue:48:8
-        // selfCycle.t1.c.d.d.d: structural cycle:
+        // selfCycle.t1.c.d.d: structural cycle:
         //     ./cycle.cue:47:5
         d: (struct){
         }
@@ -197,15 +185,7 @@
         //     ./cycle.cue:53:5
         //     ./cycle.cue:53:12
         //     ./cycle.cue:54:5
-        // selfCycle.t2.c.d: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
-        //     ./cycle.cue:53:5
-        //     ./cycle.cue:53:12
-        //     ./cycle.cue:53:20
-        // selfCycle.t2.c.d.d: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
-        //     ./cycle.cue:53:5
-        //     ./cycle.cue:53:12
-        //     ./cycle.cue:53:20
-        // selfCycle.t2.c.d.d.d: structural cycle:
+        // selfCycle.t2.c.d: structural cycle:
         //     ./cycle.cue:53:5
       }
     }
@@ -267,20 +247,20 @@
   issue3410: (struct){
     _s: (struct){
       #x: (_){ matchN(1, (#list){
-          0: (_|_){// 〈2;_s〉
-          }
-          1: (_|_){// [
+          0: (_|_){// &[〈2;_s〉]
+          }
+          1: (_|_){// &[[
             //   ...〈3;_s〉,
-            // ]
+            // ]]
           }
         }) }
     }
     #x: (_){ matchN(1, (#list){
-        0: (_|_){// 〈2;_s〉
-        }
-        1: (_|_){// [
+        0: (_|_){// &[〈2;_s〉]
+        }
+        1: (_|_){// &[[
           //   ...〈3;_s〉,
-          // ]
+          // ]]
         }
       }) }
   }
@@ -287,9 +267,9 @@
   issue3420: (struct){
     matches1: (struct){
       #S: (_){ matchN(1, (#list){
-          0: (_|_){// _
-          }
-          1: (_|_){// _|_(explicit error (_|_ literal) in source)
+          0: (_|_){// &[_]
+          }
+          1: (_|_){// &[_|_(explicit error (_|_ literal) in source)]
           }
         }) }
       s: (int){ 2 }
@@ -306,13 +286,13 @@
     }
     noCycle: (struct){
       #S: (_){ matchN(1, (#list){
-          0: (_|_){// {
+          0: (_|_){// &[{
             //   n?: (〈2;#S〉 & (int|{}))
-            // }
+            // }]
           }
         }) }
       noHang: (struct){
-        s: (struct){
+        s: (#struct){
           n: (struct){
             n: (_){ _ }
           }
@@ -321,29 +301,43 @@
     }
     noCycle2: (struct){
       #S: (_){ matchN(1, (#list){
-          0: (_|_){// {
+          0: (_|_){// &[{
             //   n?: (int|〈2;#S〉)
-            // }
-          }
-        }) }
-    }
-    cycle1: (struct){
-      #S: (_){ matchN(1, (#list){
-          0: (_|_){// {
+            // }]
+          }
+        }) }
+    }
+    cycle1: (_|_){
+      // [eval]
+      #S: (_){ matchN(1, (#list){
+          0: (_|_){// &[{
             //   n: 〈2;#S〉
-            // }
+            // }]
           }
         }) }
       ok: (struct){
         s: (_){ matchN(1, (#list){
-            0: (_|_){// {
+            0: (_|_){// &[{
               //   n: 〈2;#S〉
-              // }
+              // }]
             }
           }) }
       }
-      cycle: (struct){
-        s: (struct){
+      cycle: (_|_){
+        // [eval]
+        s: (_|_){
+          // [eval] issue3443.cycle1.cycle.s: invalid value {n:{n:_}} (does not satisfy matchN): 0 matched, expected 1:
+          //     ./matchn.cue:35:7
+          //     ./matchn.cue:35:14
+          //     ./matchn.cue:47:7
+          //     ./matchn.cue:48:7
+          // issue3443.cycle1.cycle.s.n: invalid value {n:_} (does not satisfy matchN): 0 matched, expected 1:
+          //     ./matchn.cue:35:7
+          //     ./matchn.cue:35:14
+          //     ./matchn.cue:35:22
+          //     ./matchn.cue:48:10
+          // issue3443.cycle1.cycle.s.n.n: structural cycle:
+          //     ./matchn.cue:35:7
           n: (struct){
             n: (_){ _ }
           }
@@ -363,13 +357,7 @@
           //     ./matchn.cue:55:20
           //     ./matchn.cue:55:28
           //     ./matchn.cue:55:40
-          // issue3443.cycle2.fail.#S.n.n: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
-          //     ./matchn.cue:55:13
-          //     ./matchn.cue:55:20
-          //     ./matchn.cue:55:28
-          //     ./matchn.cue:55:40
-          //     ./matchn.cue:55:43
-          // issue3443.cycle2.fail.#S.n.n.n: structural cycle:
+          // issue3443.cycle2.fail.#S.n.n: structural cycle:
           //     ./matchn.cue:55:13
           n: (#struct){
             n: (#struct){
@@ -396,11 +384,11 @@
         //     ./matchn.cue:63:29
       }
       #s: (_){ matchN(1, (#list){
-          0: (_|_){// matchN(1, [
+          0: (_|_){// &[matchN(1, [
             //   {
             //     a!: _
             //   },
-            // ])
+            // ])]
           }
         }) }
     }
-- diff/todo/p2 --
issue3443: Sort out differences in reporting of cycles.
-- out/eval --
Errors:
noCycle.t1.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:6:7
    ./cycle.cue:6:14
    ./cycle.cue:7:13
noCycle.t1.#x.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:6:7
    ./cycle.cue:6:14
    ./cycle.cue:7:13
noCycle.t1._s.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:6:7
    ./cycle.cue:6:14
    ./cycle.cue:7:13
noCycle.t1._s.#x.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:6:7
    ./cycle.cue:6:14
    ./cycle.cue:7:13
selfCycle.t1.c: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:47:5
    ./cycle.cue:47:12
    ./cycle.cue:48:5
selfCycle.t1.c.d: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:47:5
    ./cycle.cue:47:12
    ./cycle.cue:47:20
    ./cycle.cue:48:8
selfCycle.t1.c.d.d: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:47:5
    ./cycle.cue:47:12
    ./cycle.cue:47:20
    ./cycle.cue:48:8
selfCycle.t1.c.d.d.d: structural cycle:
    ./cycle.cue:47:5
selfCycle.t2.c: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:53:5
    ./cycle.cue:53:12
    ./cycle.cue:54:5
selfCycle.t2.c.d: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:53:5
    ./cycle.cue:53:12
    ./cycle.cue:53:20
selfCycle.t2.c.d.d: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
    ./cycle.cue:53:5
    ./cycle.cue:53:12
    ./cycle.cue:53:20
selfCycle.t2.c.d.d.d: structural cycle:
    ./cycle.cue:53:5
issue3443.matchIf.#S: cannot call non-function matchIf (type struct):
    ./matchn.cue:16:7
issue3443.cycle2.fail.#S: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
    ./matchn.cue:55:13
    ./matchn.cue:55:20
issue3443.cycle2.fail.#S.n: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
    ./matchn.cue:55:13
    ./matchn.cue:55:20
    ./matchn.cue:55:28
    ./matchn.cue:55:40
issue3443.cycle2.fail.#S.n.n: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
    ./matchn.cue:55:13
    ./matchn.cue:55:20
    ./matchn.cue:55:28
    ./matchn.cue:55:40
    ./matchn.cue:55:43
issue3443.cycle2.fail.#S.n.n.n: structural cycle:
    ./matchn.cue:55:13

Result:
(_|_){
  // [eval]
  noCycle: (_|_){
    // [eval]
    t1: (_|_){
      // [eval]
      _s: (_|_){
        // [eval]
        #x: (_|_){
          // [eval] noCycle.t1._s.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
          //     ./cycle.cue:6:7
          //     ./cycle.cue:6:14
          //     ./cycle.cue:7:13
          // noCycle.t1._s.#x.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
          //     ./cycle.cue:6:7
          //     ./cycle.cue:6:14
          //     ./cycle.cue:7:13
        }
      }
      #x: (_|_){
        // [eval] noCycle.t1.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:6:7
        //     ./cycle.cue:6:14
        //     ./cycle.cue:7:13
        // noCycle.t1.#x.#x: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:6:7
        //     ./cycle.cue:6:14
        //     ./cycle.cue:7:13
      }
    }
  }
  issue3649: (struct){
    noCycle: (struct){
      t1: (struct){
        data: (#struct){
          b?: (string){ string }
          a: (struct){
            b: (string){ "foo" }
          }
        }
        #c: (#struct){
          b?: (string){ string }
          a?: (_){ matchN(1, (#list){
              0: (_|_){// 〈2;#c〉
              }
            }) }
        }
      }
      t2: (struct){
        x: (struct){
          b?: (string){ string }
          y: (struct){
            a: (struct){
              d: (struct){
                b: (string){ "foo" }
              }
            }
          }
        }
        c: (struct){
          b?: (string){ string }
          y: (struct){
            a?: (_){ matchN(1, (#list){
                0: (_|_){// {
                  //   d: 〈4;c〉
                  // }
                }
              }) }
          }
        }
      }
    }
    cycle: (struct){
      t1: (struct){
        data: (#struct){
          b: (string){ string }
          a: (struct){
            b: (string){ "foo" }
          }
        }
        #c: (#struct){
          b: (string){ string }
          a: (_){ matchN(1, (#list){
              0: (_|_){// 〈2;#c〉
              }
            }) }
        }
      }
    }
  }
  yamlNoCycle: (struct){
    #c: (#struct){
      b?: (string){ string }
      a?: ((string|bytes)){ "encoding/yaml".Validate(yamlNoCycle.#c) }
    }
    data: (#struct){
      b?: (string){ string }
      a: (string){ "{a: \"b: foo\"}" }
    }
  }
  selfCycle: (_|_){
    // [eval]
    t1: (_|_){
      // [eval]
      c: (_|_){
        // [eval] selfCycle.t1.c: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:47:5
        //     ./cycle.cue:47:12
        //     ./cycle.cue:48:5
        // selfCycle.t1.c.d: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:47:5
        //     ./cycle.cue:47:12
        //     ./cycle.cue:47:20
        //     ./cycle.cue:48:8
        // selfCycle.t1.c.d.d: invalid value {d:{}} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:47:5
        //     ./cycle.cue:47:12
        //     ./cycle.cue:47:20
        //     ./cycle.cue:48:8
        // selfCycle.t1.c.d.d.d: structural cycle:
        //     ./cycle.cue:47:5
        d: (struct){
        }
      }
    }
    t2: (_|_){
      // [eval]
      c: (_|_){
        // [eval] selfCycle.t2.c: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:53:5
        //     ./cycle.cue:53:12
        //     ./cycle.cue:54:5
        // selfCycle.t2.c.d: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:53:5
        //     ./cycle.cue:53:12
        //     ./cycle.cue:53:20
        // selfCycle.t2.c.d.d: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./cycle.cue:53:5
        //     ./cycle.cue:53:12
        //     ./cycle.cue:53:20
        // selfCycle.t2.c.d.d.d: structural cycle:
        //     ./cycle.cue:53:5
      }
    }
  }
  builtinCyclePerm0: (struct){
    X: (string){ "mod.test" }
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
  }
  builtinCyclePerm1: (struct){
    X: (string){ "mod.test" }
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
  }
  builtinCyclePerm2: (struct){
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
    X: (string){ "mod.test" }
  }
  builtinCyclePerm3: (struct){
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
    X: (string){ "mod.test" }
  }
  builtinCyclePerm4: (struct){
    X: (string){ "mod.test" }
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
  }
  builtinCyclePerm5: (struct){
    X: (string){ "mod.test" }
    Y: (struct){
      #components: (#struct){
        host: (string){ "mod.test" }
      }
      host: (string){ "mod.test" }
    }
  }
  issue3410: (struct){
    _s: (struct){
      #x: (_){ matchN(1, (#list){
          0: (_|_){// 〈2;_s〉
          }
          1: (_|_){// [
            //   ...〈3;_s〉,
            // ]
          }
        }) }
    }
    #x: (_){ matchN(1, (#list){
        0: (_|_){// 〈2;_s〉
        }
        1: (_|_){// [
          //   ...〈3;_s〉,
          // ]
        }
      }) }
  }
  issue3420: (struct){
    matches1: (struct){
      #S: (_){ matchN(1, (#list){
          0: (_|_){// _
          }
          1: (_|_){// _|_(explicit error (_|_ literal) in source)
          }
        }) }
      s: (int){ 2 }
    }
  }
  issue3443: (_|_){
    // [eval]
    matchIf: (_|_){
      // [eval]
      #S: (_|_){
        // [eval] issue3443.matchIf.#S: cannot call non-function matchIf (type struct):
        //     ./matchn.cue:16:7
      }
    }
    noCycle: (struct){
      #S: (_){ matchN(1, (#list){
          0: (_|_){// {
            //   n?: (〈2;#S〉 & (int|{}))
            // }
          }
        }) }
      noHang: (struct){
        s: (struct){
          n: (struct){
            n: (_){ _ }
          }
        }
      }
    }
    noCycle2: (struct){
      #S: (_){ matchN(1, (#list){
          0: (_|_){// {
            //   n?: (int|〈2;#S〉)
            // }
          }
        }) }
    }
    cycle1: (struct){
      #S: (_){ matchN(1, (#list){
          0: (_|_){// {
            //   n: 〈2;#S〉
            // }
          }
        }) }
      ok: (struct){
        s: (_){ matchN(1, (#list){
            0: (_|_){// {
              //   n: 〈2;#S〉
              // }
            }
          }) }
      }
      cycle: (struct){
        s: (struct){
          n: (struct){
            n: (_){ _ }
          }
        }
      }
    }
    cycle2: (_|_){
      // [eval]
      fail: (_|_){
        // [eval]
        #S: (_|_){
          // [eval] issue3443.cycle2.fail.#S: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
          //     ./matchn.cue:55:13
          //     ./matchn.cue:55:20
          // issue3443.cycle2.fail.#S.n: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
          //     ./matchn.cue:55:13
          //     ./matchn.cue:55:20
          //     ./matchn.cue:55:28
          //     ./matchn.cue:55:40
          // issue3443.cycle2.fail.#S.n.n: invalid value {n:{n:{n:_}}} (does not satisfy matchN): 0 matched, expected 1:
          //     ./matchn.cue:55:13
          //     ./matchn.cue:55:20
          //     ./matchn.cue:55:28
          //     ./matchn.cue:55:40
          //     ./matchn.cue:55:43
          // issue3443.cycle2.fail.#S.n.n.n: structural cycle:
          //     ./matchn.cue:55:13
          n: (#struct){
            n: (#struct){
              n: (_){ _ }
            }
          }
        }
      }
    }
  }
  issue3633: (struct){
    final: (struct){
      data: (_|_){
        // [incomplete] issue3633.final.data: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./matchn.cue:63:6
        //     ./matchn.cue:62:8
        //     ./matchn.cue:63:13
        // issue3633.final.data: invalid value {} (does not satisfy matchN): 0 matched, expected 1:
        //     ./matchn.cue:63:17
        //     ./matchn.cue:62:8
        //     ./matchn.cue:63:24
        // issue3633.final.data.a: field is required but not present:
        //     ./matchn.cue:63:17
        //     ./matchn.cue:63:29
      }
      #s: (_){ matchN(1, (#list){
          0: (_|_){// matchN(1, [
            //   {
            //     a!: _
            //   },
            // ])
          }
        }) }
    }
  }
}
-- out/compile --
--- cycle.cue
{
  noCycle: {
    t1: {
      〈0;_s〉
      _s: {
        #x: matchN(1, [
          〈2;_s〉,
        ])
        #x: {}
      }
    }
  }
  issue3649: {
    noCycle: {
      t1: {
        data: 〈0;#c〉
        data: {
          a: {
            b: "foo"
          }
        }
        #c: {
          b?: string
          a?: matchN(1, [
            〈2;#c〉,
          ])
        }
      }
    }
  }
  issue3649: {
    noCycle: {
      t2: {
        x: 〈0;c〉
        x: {
          y: {
            a: {
              d: {
                b: "foo"
              }
            }
          }
        }
        c: {
          b?: string
          y: {
            a?: matchN(1, [
              {
                d: 〈4;c〉
              },
            ])
          }
        }
      }
    }
  }
  issue3649: {
    cycle: {
      t1: {
        data: 〈0;#c〉
        data: {
          a: {
            b: "foo"
          }
        }
        #c: {
          b: string
          a: matchN(1, [
            〈2;#c〉,
          ])
        }
      }
    }
  }
  yamlNoCycle: {
    #c: {
      b?: string
      a?: 〈import;"encoding/yaml"〉.Validate(〈1;#c〉)
    }
    data: 〈0;#c〉
    data: {
      a: "{a: \"b: foo\"}"
    }
  }
  selfCycle: {
    t1: {
      c: matchN(1, [
        {
          d: 〈2;c〉
        },
      ])
      c: {
        d: {}
      }
    }
  }
  selfCycle: {
    t2: {
      c: matchN(1, [
        {
          d: 〈2;c〉
        },
      ])
      c: {}
    }
  }
}
--- in.cue
{
  builtinCyclePerm0: {
    X: "mod.test"
    Y: {
      #components: 〈import;regexp〉.FindNamedSubmatch("^(?P<host>[[:alnum:].]+)$", 〈1;X〉)
      host: 〈0;#components〉.host
    }
    X: 〈0;Y〉.host
  }
  builtinCyclePerm1: {
    X: 〈0;Y〉.host
    Y: {
      #components: 〈import;regexp〉.FindNamedSubmatch("^(?P<host>[[:alnum:].]+)$", 〈1;X〉)
      host: 〈0;#components〉.host
    }
    X: "mod.test"
  }
  builtinCyclePerm2: {
    Y: {
      #components: 〈import;regexp〉.FindNamedSubmatch("^(?P<host>[[:alnum:].]+)$", 〈1;X〉)
      host: 〈0;#components〉.host
    }
    X: 〈0;Y〉.host
    X: "mod.test"
  }
  builtinCyclePerm3: {
    Y: {
      #components: 〈import;regexp〉.FindNamedSubmatch("^(?P<host>[[:alnum:].]+)$", 〈1;X〉)
      host: 〈0;#components〉.host
    }
    X: "mod.test"
    X: 〈0;Y〉.host
  }
  builtinCyclePerm4: {
    X: "mod.test"
    X: 〈0;Y〉.host
    Y: {
      #components: 〈import;regexp〉.FindNamedSubmatch("^(?P<host>[[:alnum:].]+)$", 〈1;X〉)
      host: 〈0;#components〉.host
    }
  }
  builtinCyclePerm5: {
    X: 〈0;Y〉.host
    X: "mod.test"
    Y: {
      #components: 〈import;regexp〉.FindNamedSubmatch("^(?P<host>[[:alnum:].]+)$", 〈1;X〉)
      host: 〈0;#components〉.host
    }
  }
}
--- matchn.cue
{
  issue3410: {
    〈0;_s〉
    _s: {
      #x: matchN(1, [
        〈2;_s〉,
        [
          ...〈3;_s〉,
        ],
      ])
    }
  }
  issue3420: {
    matches1: {
      #S: matchN(1, [
        _,
        _|_(explicit error (_|_ literal) in source),
      ])
      s: 2
    }
  }
  issue3443: {
    matchIf: {
      #S: 〈1;matchIf〉({
        x?: "b"
      }, {
        n?: (〈1;#S〉 & (int|{}))
      }, _)
    }
    noCycle: {
      #S: matchN(1, [
        {
          n?: (〈2;#S〉 & (int|{}))
        },
      ])
      noHang: {
        s: 〈1;#S〉
        s: {
          n: {
            n: _
          }
        }
      }
    }
    noCycle2: {
      #S: matchN(1, [
        {
          n?: (int|〈2;#S〉)
        },
      ])
    }
    cycle1: {
      #S: matchN(1, [
        {
          n: 〈2;#S〉
        },
      ])
      ok: {
        s: 〈1;#S〉
        s: _
      }
      cycle: {
        s: 〈1;#S〉
        s: {
          n: {
            n: _
          }
        }
      }
    }
    cycle2: {
      fail: {
        #S: (matchN(1, [
          {
            n: 〈2;#S〉
          },
        ]) & {
          n: {
            n: {
              n: _
            }
          }
        })
      }
    }
  }
  issue3633: {
    final: {
      data: ({} & 〈0;#s〉)
      #s: matchN(1, [
        matchN(1, [
          {
            a!: _
          },
        ]),
      ])
    }
  }
}
