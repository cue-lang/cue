-- in.cue --
safeCycle: simple2: {
	y: [string]: b: c: y
	x: y
	x: c: y
}

safeCycle: long1: {
	y: [string]: b: y
	x: y
	x: c: b: e: b: c: _
}

safeCycle: long2: {
	a: [string]: b: a
	x: a
	x: c: b: c: b: c: {}
}

noCancelSelfInvoke: t1: {
	y: [string]: b: y
	x: y
	x: c: x
}

// Even though these cycles cross pattern boundaries, they are still structural
// cycles as the reference includes a field that triggers the pattern.
selfTriggerCycle: _

selfTriggerCycle: t1: {
	a: #T
	#T: {
		[string]: #T
		b: {}
	}
}

selfTriggerCycle: t2: {
	#T: [string]: X={
		a: X
	}
	b: #T
	b: c: {}
}

selfTriggerCycle: long1: {
	// The long string of nested fields will initially exempt the structural
	// cycle, but they will eventually run out, causing the cycle to be
	// triggered.
	a: [string]: b: a     // -> record conjunct from pattern per field.
	a: c: b: c: b: c: {}  // -> track if any of the fields is not a cycle.
}

selfTriggerCycle: issue1503: {
	a: #T & {
		a: one: link: a: two: {}
	}
	#T: {
		a: [string]: link: #T
		a: b: {}
	}
}

mutuallyTriggeringCycle: t1: {
	// Even though y itself, as well as each of the x fields are not cyclic,
	// the combination of the two x conjuncts are, as the b fields of y will
	// trigger the pattern constraints in an interleaved fashion.
	y: [string]: b: y
	x: y
	x: c: y
}

-- out/compile --
--- in.cue
{
  safeCycle: {
    simple2: {
      y: {
        [string]: {
          b: {
            c: 〈3;y〉
          }
        }
      }
      x: 〈0;y〉
      x: {
        c: 〈1;y〉
      }
    }
  }
  safeCycle: {
    long1: {
      y: {
        [string]: {
          b: 〈2;y〉
        }
      }
      x: 〈0;y〉
      x: {
        c: {
          b: {
            e: {
              b: {
                c: _
              }
            }
          }
        }
      }
    }
  }
  safeCycle: {
    long2: {
      a: {
        [string]: {
          b: 〈2;a〉
        }
      }
      x: 〈0;a〉
      x: {
        c: {
          b: {
            c: {
              b: {
                c: {}
              }
            }
          }
        }
      }
    }
  }
  noCancelSelfInvoke: {
    t1: {
      y: {
        [string]: {
          b: 〈2;y〉
        }
      }
      x: 〈0;y〉
      x: {
        c: 〈1;x〉
      }
    }
  }
  selfTriggerCycle: _
  selfTriggerCycle: {
    t1: {
      a: 〈0;#T〉
      #T: {
        [string]: 〈1;#T〉
        b: {}
      }
    }
  }
  selfTriggerCycle: {
    t2: {
      #T: {
        [string]: {
          a: 〈1〉
        }
      }
      b: 〈0;#T〉
      b: {
        c: {}
      }
    }
  }
  selfTriggerCycle: {
    long1: {
      a: {
        [string]: {
          b: 〈2;a〉
        }
      }
      a: {
        c: {
          b: {
            c: {
              b: {
                c: {}
              }
            }
          }
        }
      }
    }
  }
  selfTriggerCycle: {
    issue1503: {
      a: (〈0;#T〉 & {
        a: {
          one: {
            link: {
              a: {
                two: {}
              }
            }
          }
        }
      })
      #T: {
        a: {
          [string]: {
            link: 〈3;#T〉
          }
        }
        a: {
          b: {}
        }
      }
    }
  }
  mutuallyTriggeringCycle: {
    t1: {
      y: {
        [string]: {
          b: 〈2;y〉
        }
      }
      x: 〈0;y〉
      x: {
        c: 〈1;y〉
      }
    }
  }
}
-- out/eval --
Errors:
mutuallyTriggeringCycle.t1.x.c.b.b.b.b: structural cycle
noCancelSelfInvoke.t1.x.c.b.b.b: structural cycle
noCancelSelfInvoke.t1.x.c.c: structural cycle
selfTriggerCycle.issue1503.#T.a.b.link: structural cycle
selfTriggerCycle.issue1503.a.a.b.link.a.b.link: structural cycle
selfTriggerCycle.issue1503.a.a.one.link.a.b.link: structural cycle
selfTriggerCycle.issue1503.a.a.one.link.a.two.link.a.b.link: structural cycle
selfTriggerCycle.long1.a.c.b.c.b.c.b: structural cycle
selfTriggerCycle.t1.#T.b: structural cycle
selfTriggerCycle.t1.a.b.b: structural cycle
selfTriggerCycle.t2.b.c.a: structural cycle

Result:
(_|_){
  // [structural cycle]
  safeCycle: (struct){
    simple2: (struct){
      y: (struct){
      }
      x: (struct){
        c: (struct){
          b: (struct){
            c: (struct){
            }
            b: (struct){
              c: (struct){
              }
            }
          }
        }
      }
    }
    long1: (struct){
      y: (struct){
      }
      x: (struct){
        c: (struct){
          b: (struct){
            e: (struct){
              b: (struct){
                c: (struct){
                  b: (struct){
                  }
                }
              }
            }
          }
        }
      }
    }
    long2: (struct){
      a: (struct){
      }
      x: (struct){
        c: (struct){
          b: (struct){
            c: (struct){
              b: (struct){
                c: (struct){
                  b: (struct){
                  }
                }
              }
            }
          }
        }
      }
    }
  }
  noCancelSelfInvoke: (_|_){
    // [structural cycle]
    t1: (_|_){
      // [structural cycle]
      y: (struct){
      }
      x: (_|_){
        // [structural cycle]
        c: (_|_){
          // [structural cycle]
          c: (_|_){
            // [structural cycle] noCancelSelfInvoke.t1.x.c.c: structural cycle
          }
          b: (_|_){
            // [structural cycle]
            b: (_|_){
              // [structural cycle]
              b: (_|_){
                // [structural cycle] noCancelSelfInvoke.t1.x.c.b.b.b: structural cycle
              }
            }
          }
        }
      }
    }
  }
  selfTriggerCycle: (_|_){
    // [structural cycle]
    t1: (_|_){
      // [structural cycle]
      a: (_|_){
        // [structural cycle]
        b: (_|_){
          // [structural cycle]
          b: (_|_){
            // [structural cycle] selfTriggerCycle.t1.a.b.b: structural cycle
          }
        }
      }
      #T: (_|_){
        // [structural cycle]
        b: (_|_){
          // [structural cycle] selfTriggerCycle.t1.#T.b: structural cycle
        }
      }
    }
    t2: (_|_){
      // [structural cycle]
      #T: (#struct){
      }
      b: (_|_){
        // [structural cycle]
        c: (_|_){
          // [structural cycle]
          a: (_|_){
            // [structural cycle] selfTriggerCycle.t2.b.c.a: structural cycle
          }
        }
      }
    }
    long1: (_|_){
      // [structural cycle]
      a: (_|_){
        // [structural cycle]
        c: (_|_){
          // [structural cycle]
          b: (_|_){
            // [structural cycle]
            c: (_|_){
              // [structural cycle]
              b: (_|_){
                // [structural cycle]
                c: (_|_){
                  // [structural cycle]
                  b: (_|_){
                    // [structural cycle] selfTriggerCycle.long1.a.c.b.c.b.c.b: structural cycle
                  }
                }
              }
            }
          }
        }
      }
    }
    issue1503: (_|_){
      // [structural cycle]
      a: (_|_){
        // [structural cycle]
        a: (_|_){
          // [structural cycle]
          b: (_|_){
            // [structural cycle]
            link: (_|_){
              // [structural cycle]
              a: (_|_){
                // [structural cycle]
                b: (_|_){
                  // [structural cycle]
                  link: (_|_){
                    // [structural cycle] selfTriggerCycle.issue1503.a.a.b.link.a.b.link: structural cycle
                  }
                }
              }
            }
          }
          one: (_|_){
            // [structural cycle]
            link: (_|_){
              // [structural cycle]
              a: (_|_){
                // [structural cycle]
                two: (_|_){
                  // [structural cycle]
                  link: (_|_){
                    // [structural cycle]
                    a: (_|_){
                      // [structural cycle]
                      b: (_|_){
                        // [structural cycle]
                        link: (_|_){
                          // [structural cycle] selfTriggerCycle.issue1503.a.a.one.link.a.two.link.a.b.link: structural cycle
                        }
                      }
                    }
                  }
                }
                b: (_|_){
                  // [structural cycle]
                  link: (_|_){
                    // [structural cycle] selfTriggerCycle.issue1503.a.a.one.link.a.b.link: structural cycle
                  }
                }
              }
            }
          }
        }
      }
      #T: (_|_){
        // [structural cycle]
        a: (_|_){
          // [structural cycle]
          b: (_|_){
            // [structural cycle]
            link: (_|_){
              // [structural cycle] selfTriggerCycle.issue1503.#T.a.b.link: structural cycle
            }
          }
        }
      }
    }
  }
  mutuallyTriggeringCycle: (_|_){
    // [structural cycle]
    t1: (_|_){
      // [structural cycle]
      y: (struct){
      }
      x: (_|_){
        // [structural cycle]
        c: (_|_){
          // [structural cycle]
          b: (_|_){
            // [structural cycle]
            b: (_|_){
              // [structural cycle]
              b: (_|_){
                // [structural cycle]
                b: (_|_){
                  // [structural cycle] mutuallyTriggeringCycle.t1.x.c.b.b.b.b: structural cycle
                }
              }
            }
          }
        }
      }
    }
  }
}
