-- in.cue --
import (
	"encoding/yaml"
	"regexp"
)

simplified: { // TODO(broken)
	x: d: R={
		".*"
		[R+""][0]
	}
	out: yaml.Marshal(x)
}

original: { // TODO(broken)
	#testableRegexp: R={
		string

		#test: close({
			in:  string
			out: regexp.FindSubmatch("^"+R+"$", in)[1]
		})
	}

	rule: {
		#patterns: {
			bar: #testableRegexp & {
				"(.*)"
				#test: {in: "testcontent", out: "testcontent"}
			}
		}
	}
	out: yaml.Marshal(rule)
}
-- out/eval/stats --
Leaks:  3
Freed:  21
Reused: 12
Allocs: 12
Retain: 4

Unifications: 24
Conjuncts:    42
Disjuncts:    24
-- out/eval --
Errors:
simplified.out: error in call to encoding/yaml.Marshal: assertion failed: no BaseValue: state: finalized; requested: partial:
    ./in.cue:11:7
original.out: error in call to encoding/yaml.Marshal: assertion failed: no BaseValue: state: finalized; requested: partial:
    ./in.cue:32:7

Result:
(_|_){
  // [eval]
  simplified: (_|_){
    // [eval]
    x: (struct){
      d: (string){ ".*" }
    }
    out: (_|_){
      // [eval] simplified.out: error in call to encoding/yaml.Marshal: assertion failed: no BaseValue: state: finalized; requested: partial:
      //     ./in.cue:11:7
    }
  }
  original: (_|_){
    // [eval]
    #testableRegexp: (string){
      string
      #test: (#struct){
        in: (string){ string }
        out: (_|_){
          // [incomplete] original.#testableRegexp.#test.out: non-concrete value string in operand to +:
          //     ./in.cue:20:29
          //     ./in.cue:15:21
          //     ./in.cue:16:3
        }
      }
    }
    rule: (struct){
      #patterns: (#struct){
        bar: (string){
          "(.*)"
          #test: (#struct){
            in: (string){ "testcontent" }
            out: (string){ "testcontent" }
          }
        }
      }
    }
    out: (_|_){
      // [eval] original.out: error in call to encoding/yaml.Marshal: assertion failed: no BaseValue: state: finalized; requested: partial:
      //     ./in.cue:32:7
    }
  }
}
