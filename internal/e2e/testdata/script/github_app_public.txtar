# Create a public GitHub repository in an organization
# where the registry account owning $CUE_REGISTRY_TOKEN
# has read-write access to all GitHub repositories.
# Publish a version for this new repository with `cue mod publish`,
# and then fetch the module as a dependency via cmd/cue.

create-github-repo
env VERSION=v0.0.1
env MODVER=${MODULE}@v0

cd publish

# TODO: replace by "cue mod init" once we can programatically insert
# a language.version string, such as via "cue mod edit".
# Otherwise registry.cue.works complains about the lack of language.version.
# cue mod init ${MODVER}
env-fill cue.mod/module.cue

exec cue mod publish ${VERSION}

cd ../depend

env-fill out_foo.cue
exec cue mod init depend.localhost
exec cue mod tidy
exec cue export
cmp stdout export.golden

-- publish/cue.mod/module.cue --
module: "${MODVER}"
language: {
	version: "v0.8.0-alpha.3"
}
-- publish/foo.cue --
package publish

foo: "foo value"

-- depend/out_foo.cue --
package depend

import mt "${MODVER}:publish"

out: mt.foo
-- depend/export.golden --
{
    "out": "foo value"
}
