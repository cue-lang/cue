#FindHiddenTasks: true
-- in.cue --

// TODO test when root has the list embedded and
// some hidden task fields too. See https://github.com/cue-lang/cue/issues/2366.
root: [
	{
		$id: "valToOut"
		val: "foo"
		out: string
	},
	{
		$id:    "valToOut"
		$after: root[0]
		val:    "bar"
		out:    string
	},
	{
		$id: "valToOut"
		out: root[0].out + root[1].out
	},
]

-- out/run/errors --
-- out/run/t0 --
graph TD
  t0("root[0] [Ready]")
  t1("root[1] [Waiting]")
  t1-->t0
  t2("root[2] [Waiting]")
  t2-->t0
  t2-->t1

-- out/run/t1 --
graph TD
  t0("root[0] [Terminated]")
  t1("root[1] [Ready]")
  t1-->t0
  t2("root[2] [Waiting]")
  t2-->t0
  t2-->t1

-- out/run/t1/value --
{
	$id: "valToOut"
	val: "foo"
	out: "foo"
}
-- out/run/t2 --
graph TD
  t0("root[0] [Terminated]")
  t1("root[1] [Terminated]")
  t1-->t0
  t2("root[2] [Ready]")
  t2-->t0
  t2-->t1

-- out/run/t2/value --
{
	$id: "valToOut"
	$after: {
		$id: "valToOut"
		val: "foo"
		out: "foo"
	}
	val: "bar"
	out: "bar"
}
-- out/run/t3 --
graph TD
  t0("root[0] [Terminated]")
  t1("root[1] [Terminated]")
  t1-->t0
  t2("root[2] [Terminated]")
  t2-->t0
  t2-->t1

-- out/run/t3/value --
{
	$id: "valToOut"
	out: "foobar"
}
